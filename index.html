<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>77Store - Gallery</title>
<link rel="icon" href="./favicon.ico" />
<style>
:root{
  --accent:#2b82c9;
  --muted:#9aa8b6;
  --card-bg:#0f1315;
  --card-surface:#0f1315;
  --thumb-radius:8px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:system-ui,Arial;margin:0;background:#0b0d0e;color:#e6e9eb}
header{ background: #0f171a; padding:12px; position:sticky; top:0; z-index:60; border-bottom:1px solid rgba(255,255,255,0.03) }
.header-inner{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap }
.brand{ color:#79b9ff; font-weight:700; font-size:16px }
.search-wrap{ flex:1 1 280px; max-width:420px }
.search-input{ width:100%; padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:#0b0f10; color:#e6e9eb }
.header-actions{ display:flex; gap:8px; align-items:center }
.btn{ padding:7px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#e6e9eb; cursor:pointer; font-size:14px }
.btn.primary{ background:var(--accent); color:#fff; border-color: rgba(0,0,0,0.2) }
.btn.small{ padding:6px 8px; font-size:13px }
.clear-key{ color:#ff6b6b; background:transparent; border:none; cursor:pointer; font-size:13px }

.tabs{ display:flex; gap:8px; padding:12px 8px; overflow:auto; background: rgba(255,255,255,0.02); border-bottom:1px solid rgba(255,255,255,0.02) }
.tab{ padding:8px 12px; border-radius:10px; background: rgba(255,255,255,0.02); color:#cfe9ff; border:1px solid rgba(255,255,255,0.02); cursor:pointer; white-space:nowrap; font-size:14px }
.tab.active{ background:#1d88d0; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.5) }

main{ padding:14px; max-width:1100px; margin:0 auto }

.top-status{ color:#9aa8b6; margin-bottom:8px }

.actions-bar{ display:flex; gap:8px; align-items:center; margin-bottom:12px }

.section-title{ color:#cfe9ff; font-weight:600; margin:8px 0 }

.grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px }
@media(max-width:900px){ .grid{ grid-template-columns: repeat(2, 1fr) } }
@media(max-width:480px){ .grid{ grid-template-columns: repeat(3, 1fr); gap:10px } }

.card{ background:#0f1315; border-radius:12px; padding:8px; box-shadow: 0 4px 12px rgba(0,0,0,0.6); position:relative; overflow:visible; border:1px solid rgba(255,255,255,0.03) }
.thumb-wrap{ width:100%; aspect-ratio:1/1; border-radius:10px; overflow:hidden; background:#0b0d0e; display:block }
.card img{ width:100%; height:100%; object-fit:cover; display:block }
.card .card-bottom{ margin-top:8px; display:flex; gap:8px; align-items:center; justify-content:space-between }
.share-btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:#e6e9eb; cursor:pointer }
.barcode-strong{ font-weight:700; color:#fff; display:block; margin-top:6px; text-align:center }

.checkbox-select{ position:absolute; left:8px; top:8px; z-index:20; width:26px; height:26px; transform:scale(1.2); display:none }

/* when multi-select mode enabled, show checkbox */
.mode-select .checkbox-select{ display:block }

.float-delete{ position:fixed; left:12px; bottom:12px; z-index:200; display:none }
.float-delete button{ background:#ff3b30; color:#fff; border:1px solid rgba(0,0,0,0.2); padding:12px 16px; border-radius:12px; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,0.5); cursor:pointer }

/* modal styles (simple) */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:250; background: rgba(0,0,0,0.5) }
.modal.open{ display:flex }
.modal-content{ background:#0c1112; color:#e6e9eb; width:92%; max-width:720px; border-radius:12px; overflow:auto; max-height:86vh; padding:12px; border:1px solid rgba(255,255,255,0.03) }
.modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
.modal-body img{ max-width:100%; display:block; margin-bottom:6px }

/* small tweaks */
.small-muted{ color:#9aa8b6; font-size:13px }
</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="brand">77Store - Gallery</div>
    </div>

    <div class="search-wrap">
      <input id="searchInput" class="search-input" placeholder="Tìm theo barcode (VD: 146888) — Enter để tìm" />
    </div>

    <div class="header-actions">
      <button id="themeToggle" class="btn small">Light/Dark</button>
      <button id="refreshBtn" class="btn small">Refresh</button>
      <button id="clearKeyBtn" class="clear-key">Clear Key</button>
    </div>
  </div>

  <div id="tabs" class="tabs" style="margin-top:12px"></div>
</header>

<main>
  <div class="top-status" id="status">Loaded manifest (đang tải...)</div>

  <div class="actions-bar" id="actionsBar">
    <!-- toggle "Chọn xóa" button inserted by JS -->
  </div>

  <div id="content"></div>
</main>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <div><strong id="modalTitle">Preview</strong></div>
      <div><button id="modalClose" class="btn small">Đóng</button></div>
    </div>
    <div id="modalBody" class="modal-body"></div>
  </div>
</div>

<!-- floating delete -->
<div id="floatDelete" class="float-delete" aria-hidden="true">
  <button id="floatDeleteBtn">Xóa</button>
</div>

<script>
/* Config */
const WORKER_BASE = "https://shoes-worker.lapproak0.workers.dev";
const PREFIX = "Shoes";

/* DOM */
const tabsEl = document.getElementById('tabs');
const statusEl = document.getElementById('status');
const contentEl = document.getElementById('content');
const actionsBar = document.getElementById('actionsBar');
const searchInput = document.getElementById('searchInput');
const refreshBtn = document.getElementById('refreshBtn');
const clearKeyBtn = document.getElementById('clearKeyBtn');
const themeToggle = document.getElementById('themeToggle');

const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
document.getElementById('modalClose').onclick = ()=> closeModal();

const floatDelete = document.getElementById('floatDelete');
const floatDeleteBtn = document.getElementById('floatDeleteBtn');

/* state */
let manifestRaw = null;
let manifest = { sizes: [] };
let manifestMap = {};
let activeTab = 'all';
let multiSelectMode = false; // when true, checkboxes visible and float delete shown
let selectedItems = new Set(); // keys: "size|barcode"

/* admin session storage */
function getAdminKeySession(){ return sessionStorage.getItem('admin_key_v1') || null; }
function setAdminKeySession(key){ if(!key) sessionStorage.removeItem('admin_key_v1'); else sessionStorage.setItem('admin_key_v1', key); }
function promptAdminKeyIfNeeded(){ const existing = getAdminKeySession(); if(existing) return existing; const k = prompt('Nhập ADMIN_KEY (lưu trong session phiên này):'); if(!k) return null; setAdminKeySession(k.trim()); return k.trim(); }

/* theme */
(function(){
  const dark = true; // default dark as screenshot
  if(dark) document.body.classList.add('dark');
})();
themeToggle.onclick = ()=> { document.body.classList.toggle('dark'); };

/* helpers */
function logStatus(s){ statusEl.textContent = s; }
function openModal(title, htmlOrNode){ modalTitle.textContent = title; if(typeof htmlOrNode === 'string') modalBody.innerHTML = htmlOrNode; else { modalBody.innerHTML=''; modalBody.appendChild(htmlOrNode);} modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }

/* normalize manifest incoming */
function normalizeManifest(raw){
  if(!raw) return { sizes: [] };
  if(Array.isArray(raw)) return { sizes: raw };
  if(raw.sizes && Array.isArray(raw.sizes)) return { sizes: raw.sizes };
  const sizes=[];
  for(const [k,v] of Object.entries(raw)){
    if(k==='meta'||k==='version') continue;
    if(v && typeof v === 'object'){
      const barcodes=[];
      for(const [code, imgs] of Object.entries(v)) if(Array.isArray(imgs)) barcodes.push({ code: String(code), images: imgs.slice() });
      sizes.push({ size: String(k), barcodes });
    }
  }
  return { sizes };
}
function buildManifestMap(){
  manifestMap = {};
  for(const s of manifest.sizes){
    manifestMap[s.size] = manifestMap[s.size] || {};
    for(const b of s.barcodes) manifestMap[s.size][b.code] = true;
  }
}

/* fetch manifest */
async function fetchManifest({ force=false }={}) {
  try {
    logStatus('Loading manifest...');
    const url = WORKER_BASE + '/manifest.json' + (force ? '?refresh=1' : '');
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error('manifest fetch error ' + res.status);
    manifestRaw = await res.json();
    manifest = normalizeManifest(manifestRaw || {});
    buildManifestMap();
    logStatus('Loaded manifest (sizes: ' + manifest.sizes.length + ')');
    buildTabs();
  } catch(e){
    console.error(e);
    logStatus('Không load được manifest: ' + (e.message||e));
    contentEl.innerHTML = '';
  }
}

/* tabs */
function createTabButton(text, key){
  const btn = document.createElement('button');
  btn.className = 'tab' + (activeTab===key ? ' active' : '');
  btn.textContent = text;
  btn.onclick = ()=> { activeTab = key; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active'); renderAccording(); };
  return btn;
}
function buildTabs(){
  tabsEl.innerHTML = '';
  tabsEl.appendChild(createTabButton('Tất cả','all'));
  for(const s of manifest.sizes) tabsEl.appendChild(createTabButton('Size ' + s.size, 'size:'+s.size));
  tabsEl.appendChild(createTabButton('Thêm','add'));
  // set active
  const cur = document.querySelector(`.tab[aria-pressed="true"]`);
}

/* render functions */
function makeCard(size, bc){
  const card = document.createElement('div'); card.className='card';
  const key = `${size}|${bc.code}`;

  // checkbox (visible when multiSelectMode)
  const cb = document.createElement('input'); cb.type='checkbox'; cb.className='checkbox-select';
  cb.checked = selectedItems.has(key);
  cb.onchange = (e)=> {
    if(e.target.checked) selectedItems.add(key); else selectedItems.delete(key);
  };
  card.appendChild(cb);

  const thumbWrap = document.createElement('div'); thumbWrap.className='thumb-wrap';
  const thumbName = (Array.isArray(bc.images) && bc.images.find(x=>/thumb/i.test(x))) || (Array.isArray(bc.images) ? bc.images[0] : null) || 'thumb.jpeg';
  const src = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(String(size).trim())}/${encodeURIComponent(String(bc.code).trim())}/${encodeURIComponent(thumbName)}`;
  const img = document.createElement('img'); img.src = src; img.alt = bc.code;
  img.onerror = ()=>{ img.style.objectFit='contain'; img.style.opacity=0.7; };
  img.onclick = ()=> openDetails(size, bc);
  thumbWrap.appendChild(img);
  card.appendChild(thumbWrap);

  const bottom = document.createElement('div'); bottom.className='card-bottom';
  const shareBtn = document.createElement('button'); shareBtn.className='share-btn';
  shareBtn.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' style='vertical-align:middle'><g fill='none' stroke='currentColor' stroke-width='1.4' stroke-linecap='round' stroke-linejoin='round'><rect x='9' y='4' width='11' height='11' rx='1.2' /><rect x='4' y='9' width='11' height='11' rx='1.2' /></g></svg> Share <span style="font-weight:700;margin-left:6px">${bc.code}</span>`;
  shareBtn.onclick = ()=> shareMultipleImages(size, bc);
  bottom.appendChild(shareBtn);
  card.appendChild(bottom);

  return card;
}

function openDetails(size, bc){
  modalBody.innerHTML = '';
  modalTitle.textContent = `${size} — ${bc.code}`;
  const box = document.createElement('div');
  box.style.display = 'grid';
  box.style.gridTemplateColumns = '1fr 1fr';
  box.style.gap = '8px';
  for(const fn of (bc.images || [])){
    const im = document.createElement('img');
    im.src = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(String(size).trim())}/${encodeURIComponent(String(bc.code).trim())}/${encodeURIComponent(fn)}`;
    im.style.width = '100%';
    box.appendChild(im);
  }
  modalBody.appendChild(box);
  modal.classList.add('open');
}

function renderAll(){
  contentEl.innerHTML = '';
  const top = document.createElement('div'); top.className='actions-bar';
  // toggle button will be inserted by renderActionsBar()
  contentEl.appendChild(top);

  for(const s of manifest.sizes){
    const h = document.createElement('div'); h.className='section-title'; h.textContent = 'Size ' + s.size; contentEl.appendChild(h);
    const grid = document.createElement('div'); grid.className='grid';
    for(const bc of s.barcodes) grid.appendChild(makeCard(s.size, bc));
    contentEl.appendChild(grid);
  }
}

function renderSize(sizeStr){
  contentEl.innerHTML = '';
  const top = document.createElement('div'); top.className='actions-bar';
  contentEl.appendChild(top);
  const s = manifest.sizes.find(x=>String(x.size)===String(sizeStr));
  if(!s){ contentEl.innerHTML = '<div class="small-muted">Không có size này</div>'; return; }
  const grid = document.createElement('div'); grid.className='grid';
  for(const bc of s.barcodes) grid.appendChild(makeCard(s.size, bc));
  contentEl.appendChild(grid);
}

/* render add tab (keep minimal) */
function renderAdd(){
  contentEl.innerHTML = '';
  const box = document.createElement('div');
  box.className = 'modal-content';
  box.style.background = 'transparent';
  box.innerHTML = `<div style="padding:8px;background:#081014;border-radius:8px"><div style="color:#cfe9ff;font-weight:600">Thêm hàng (Upload)</div><div class="small-muted" style="margin-top:6px">Dùng trang Upload để thêm ảnh vào R2</div></div>`;
  contentEl.appendChild(box);
}

/* render based on activeTab */
function renderAccording(){
  // set body class for mode: to show checkboxes
  if(multiSelectMode) document.body.classList.add('mode-select'); else document.body.classList.remove('mode-select');
  // render actions bar
  renderActionsBar();

  if(activeTab==='all') renderAll();
  else if(activeTab.startsWith('size:')) renderSize(activeTab.split(':')[1]);
  else if(activeTab==='add') renderAdd();
}

/* render actions bar with toggle "Chọn xóa" */
function renderActionsBar(){
  actionsBar.innerHTML = '';
  const left = document.createElement('div');
  const toggleBtn = document.createElement('button');
  toggleBtn.className = 'btn';
  toggleBtn.textContent = multiSelectMode ? 'Hủy' : 'Chọn xóa';
  toggleBtn.onclick = ()=> {
    multiSelectMode = !multiSelectMode;
    if(!multiSelectMode) {
      selectedItems.clear();
      floatDelete.style.display = 'none';
    } else {
      floatDelete.style.display = 'block';
    }
    renderAccording();
  };
  left.appendChild(toggleBtn);
  actionsBar.appendChild(left);

  const right = document.createElement('div');
  right.style.display = 'flex'; right.style.gap='8px'; right.style.alignItems='center';
  const small = document.createElement('div'); small.className='small-muted'; small.textContent = 'Loaded manifest (sizes: ' + manifest.sizes.length + ')';
  right.appendChild(small);
  actionsBar.appendChild(right);
}

/* share single card function (keeps simple) */
async function shareMultipleImages(size, barcodeObj){
  // fetch files (parallel, but cap)
  const MAX_FILES = 12;
  const imgs = (barcodeObj.images || []).slice(0, MAX_FILES);
  if(imgs.length === 0) return alert('Không có ảnh để chia sẻ');
  openModal('Chuẩn bị chia sẻ', '<div id="prepareMsg">Đang tải ảnh...</div>');
  const urls = imgs.map(fn => `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(String(size).trim())}/${encodeURIComponent(String(barcodeObj.code).trim())}/${encodeURIComponent(fn)}`);
  try {
    const ps = urls.map(u => fetch(u, { mode:'cors' }).then(r => r.ok ? r.blob() : null).catch(()=>null));
    const blobs = await Promise.all(ps);
    const files = blobs.filter(Boolean).map((b,i) => new File([b], decodeURIComponent(urls[i].split('/').pop()), { type: b.type }));
    closeModal();
    if(files.length === 0) return alert('Không tải được file để chia sẻ');
    try {
      if(navigator.canShare && navigator.canShare({ files })) {
        await navigator.share({ files, title: 'Images ' + barcodeObj.code });
      } else {
        alert('Trình duyệt không hỗ trợ chia sẻ file trực tiếp.');
      }
    } catch(e){
      console.warn('share failed', e);
      alert('Chia sẻ thất bại: ' + (e.message||e));
    }
  } catch(e){
    closeModal();
    console.error(e);
    alert('Lỗi khi chuẩn bị chia sẻ: ' + (e.message||e));
  }
}

/* FLOAT DELETE handling */
floatDeleteBtn.onclick = async ()=>{
  if(!multiSelectMode) return;
  if(selectedItems.size === 0) return alert('Chưa chọn mục nào để xóa');
  // no extra confirm as requested previously; will require admin key
  const key = promptAdminKeyIfNeeded();
  if(!key) return alert('Cần ADMIN_KEY để xóa');
  // build items
  const items = Array.from(selectedItems).map(s=>{ const [size, barcode] = s.split('|'); return { size, barcode }; });
  try {
    const r = await fetch(WORKER_BASE + '/bulk-delete', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': key }, body: JSON.stringify({ items }) });
    if(!r.ok){ const t = await r.text().catch(()=>r.statusText); throw new Error('Delete failed: ' + t); }
    const j = await r.json();
    alert('Xóa hoàn tất. Deleted keys: ' + (j.totalDeleted||0));
    // refresh manifest and UI
    selectedItems.clear();
    multiSelectMode = false;
    floatDelete.style.display = 'none';
    await fetchManifest();
    renderAccording();
  } catch(e){
    console.error(e);
    alert('Lỗi xóa: ' + (e.message||e));
  }
};

/* clicking a checkbox in cards must update selectedItems - we implemented in makeCard */
/* but need to ensure checkboxes have right key values after render: update selectedItems when rendering cards */
function refreshCardCheckboxes(){
  // run through cards, ensure state
  document.querySelectorAll('.card').forEach(card=>{
    const cb = card.querySelector('.checkbox-select');
    if(!cb) return;
    const codeText = card.querySelector('.barcode-strong') ? card.querySelector('.barcode-strong').textContent : null;
    // fallback: try to read img alt
    const img = card.querySelector('img');
    const barcode = img ? img.alt : codeText;
    // size not embedded here; we rely on checkbox checked status only
  });
}

/* search */
searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
function doSearch(){
  const q = (searchInput.value||'').trim().toLowerCase();
  if(!q) return;
  // find matching barcodes
  const matches = [];
  for(const s of manifest.sizes) for(const b of s.barcodes) if(String(b.code).toLowerCase().includes(q)) matches.push({ size: s.size, barcode: b });
  if(matches.length === 0) return alert('Không tìm thấy ' + q);
  // go to first match size
  const first = matches[0];
  activeTab = 'size:' + first.size;
  buildTabs();
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  const tb = Array.from(document.querySelectorAll('.tab')).find(t=>t.textContent.includes(first.size));
  if(tb) tb.classList.add('active');
  renderAccording();
  // scroll to first match after render
  setTimeout(()=> {
    const imgs = document.querySelectorAll('.card img');
    for(const im of imgs){ if(im.alt === first.barcode.code) { im.scrollIntoView({behavior:'smooth', block:'center'}); break; } }
  }, 300);
}

/* init */
async function init(){
  await fetchManifest();
  // build header actions bar (toggle)
  renderActionsBar();
  renderAccording();
  // hide floatDelete by default
  floatDelete.style.display = 'none';
}
init();

/* helper: when building card we added cb handlers which modify selectedItems.
   But when rendering we must ensure the checkbox's checked tied to selectedItems.
   For simplicity, re-rendering card will reset correct checked state because we set cb.checked from selectedItems.
*/

/* note: if you want automatic prefetch on clicking thumbnails or on selection to speed up share,
   we can add that later. For now basic behavior implemented as requested. */

</script>
</body>
</html>
