<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>77Store - Gallery</title>
<link rel="icon" type="image/x-icon" href="./favicon.ico">
<style>
:root{
  --accent:#2b82c9;
  --header-bg:#e6f3ff;
  --gap:8px;
  --thumb-radius:6px;
  --card-width-desktop:220px;
  --progress-max-height: 240px;
}
*{box-sizing:border-box}
body{font-family:system-ui,Arial;margin:0;background:#f0f6fb;color:#072033}
body.dark{ background:#111316; color:#d9dee3 }
header{ background:var(--header-bg); padding:10px 12px; box-shadow:0 2px 6px rgba(10,10,10,0.06); position:sticky; top:0; z-index:60; }
body.dark header{ background:#1a1f23 }
.top-row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand{font-weight:700;color:var(--accent);font-size:15px}
.search-wrap{flex:1 1 360px;margin-left:8px;min-width:120px;max-width:calc(100% - 260px)}
.search-input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:14px}
.tabs{display:flex;gap:8px;overflow:auto;padding:8px;margin-top:8px}
.tab{padding:8px 10px;border-radius:8px;background:#eaf6ff;border:1px solid #d6ecff;cursor:pointer;white-space:nowrap;font-size:13px}
.tab.active{background:var(--accent);color:white}
main{padding:10px}
.status{padding:8px 12px;color:#345;font-size:13px}
.grid{ display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
.card{ background:white;border-radius:8px;padding:8px;box-shadow:0 1px 4px rgba(12,15,30,0.06);display:flex;flex-direction:column;gap:6px;font-size:13px;position:relative;align-items:stretch }
.card .thumb-wrap{ background:#f6f8fa }
body.dark .card{ background:#15181a }
body.dark .card .thumb-wrap{ background:#222528 }
.thumb-wrap{ width:100%; aspect-ratio:1/1; overflow:hidden; border-radius:var(--thumb-radius); background:#f6f8fa }
.card img{width:100%;height:100%;object-fit:cover;display:block}
.checkbox-select{position:absolute;left:8px;top:8px;z-index:20;width:26px;height:26px;transform:scale(1.2);accent-color:var(--accent)}
.actions-bar{display:flex;gap:8px;align-items:center;margin-bottom:8px}
.btn{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;background:transparent;cursor:pointer;font-size:13px;white-space:nowrap}
.btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
.small{font-size:13px;color:#444}
.muted{color:#666;font-size:13px}
.section-title{margin:10px 0 6px;font-weight:600;font-size:14px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:120;align-items:center;justify-content:center}
.modal.open{display:flex}
.modal-content{background:white;width:92%;height:86%;border-radius:12px;display:flex;flex-direction:column;overflow:auto}
body.dark .modal-content{ background:#0f1315; color:#e6e9eb }
.modal-header{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
.modal-body{padding:10px;overflow:auto}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.two-col img{width:100%;height:auto;border-radius:6px;display:block}
@media(max-width:700px){.two-col{grid-template-columns:1fr}}
.barcode-strong{font-weight:700}
.clear-key { font-size:12px; color:#b00; border:none; background:transparent; cursor:pointer; padding:4px; }
@media (min-width: 600px) and (max-width: 999px) { .grid{ grid-template-columns: repeat(4, 1fr); gap: 10px; } }
@media (min-width: 1000px) { .grid{ display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start; } .card{ flex: 0 0 var(--card-width-desktop); max-width: var(--card-width-desktop); } }
.progress-panel { position: fixed; right: 12px; bottom: 12px; padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); width: 360px; max-width: calc(100% - 24px); background: rgba(255,255,255,0.98); border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); z-index: 130; display: none; font-size:13px; }
.progress-panel.open { display:block; }
.groups-scroll { max-height: var(--progress-max-height); overflow:auto; padding-right:6px; margin-bottom:8px; }
.progress-row { margin-bottom:8px; border-bottom:1px solid #eee; padding-bottom:6px; }
.progress-bar-bg { width:100%; height:8px; background:#eee; border-radius:6px; overflow:hidden; }
.progress-bar-fill { height:100%; width:0%; background:var(--accent); border-radius:6px; transition: width 0.12s linear; }
.progress-label { font-size:12px; color:#333; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
.file-status { font-size:11px; color:#666; }
.overall-wrap { margin-top:6px; border-top:1px solid #eee; padding-top:8px; }
.overall-label { display:flex; justify-content:space-between; align-items:center; font-size:13px; margin-bottom:6px; }
.table-wrap{ overflow:auto; }
.table-add { width:100%; min-width:900px; border-collapse:collapse; margin:6px 0; }
.table-add th, .table-add td { border:1px solid #e6eef6; padding:6px; text-align:left; vertical-align:middle; font-size:13px; }
.table-add th { background:#f7fbff; font-weight:600; }
.table-add th:nth-child(1), .table-add td:nth-child(1) { width:80px; }
.table-add th:nth-child(2), .table-add td:nth-child(2) { width:140px; }
.table-add th:nth-child(3), .table-add td:nth-child(3) { width:120px; }
.table-add th:nth-child(4), .table-add td:nth-child(4) { width:auto; }
.table-add th:nth-child(5), .table-add td:nth-child(5) { width:120px; }
.small-thumb { width:60px; height:60px; object-fit:cover; border-radius:6px; background:#fafafa; display:block; }
.row-actions { display:flex; gap:6px; align-items:center; }
.controls-left .btn{ margin-right:8px }

/* share button style: border always #ccc, background adapts to theme */
.share-btn{ border:1px solid #cccccc; background:#ffffff; color:#000; white-space:nowrap; display:inline-flex; align-items:center; gap:6px; padding:8px 10px; min-width:110px; }
body.dark .share-btn{ background:#222426; color:#e6e9eb; border-color:#444; }

/* dark table tweaks */
body.dark .table-add { background: transparent; color: #e6e9eb; }
body.dark .table-add th, body.dark .table-add td { background: transparent; border-color: #26292b; color: #e6e9eb; }

/* add tab container theme-aware */
.add-container { padding:12px; border-radius:8px; background: #fff; color: #072033; }
body.dark .add-container { background: #0f1315; color: #e6e9eb; }

/* floating actions (bottom-left) */
#floatActions { display:none; position:fixed; left:12px; bottom:12px; z-index:140; }
#floatActions .btn { white-space:nowrap; }

</style>
</head>
<body>
<header id="pageHeader">
  <div class="top-row">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="brand">77Store - Gallery</div>
    </div>
    <div class="search-wrap">
      <input id="searchInput" class="search-input" placeholder="Tìm theo barcode (VD: 146888) — Enter để tìm" />
    </div>
    <div class="header-actions">
      <button id="themeToggle" class="btn">Light/Dark</button>
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="clearKeyBtn" class="clear-key" title="Xóa Admin Key trong session">Clear Key</button>
    </div>
  </div>
  <div id="tabs" class="tabs"></div>
</header>

<main id="mainContent">
  <div id="status" class="status">Đang tải manifest...</div>
  <div id="content"></div>
</main>

<!-- modal -->
<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <div><strong id="modalTitle"></strong></div>
      <div style="display:flex;gap:8px;align-items:center"><button id="modalClose" class="btn">Đóng</button></div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- progress panel -->
<div id="progressPanel" class="progress-panel" aria-hidden="true">
  <div class="groups-scroll" id="groupsContainer"></div>
  <div class="overall-wrap">
    <div class="overall-label"><div>Overall</div><div id="overallPercent">0%</div></div>
    <div class="progress-bar-bg"><div id="overallBar" class="progress-bar-fill" style="width:0%"></div></div>
    <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="closeProgressBtn" class="btn">Ẩn</button></div>
  </div>
</div>

<!-- floating actions (bottom-left) -->
<div id="floatActions" aria-hidden="true">
  <div style="display:flex;gap:8px;align-items:center;">
    <button id="floatDeleteBtn" class="btn" style="background:#ff3b30;color:#fff;border-color:#ff3b30">Xóa</button>
    <button id="floatShareBtn" class="btn share-btn">Chia sẻ</button>
    <button id="floatCancelBtn" class="btn">Hủy</button>
  </div>
</div>

<script>
/* CONFIG */
const WORKER_BASE = "https://shoes-worker.lapproak0.workers.dev";
const PREFIX = "Shoes";

/* DOM refs */
const headerEl = document.getElementById('pageHeader');
const statusEl = document.getElementById('status');
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const searchInput = document.getElementById('searchInput');
const refreshBtn = document.getElementById('refreshBtn');
const clearKeyBtn = document.getElementById('clearKeyBtn');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const themeToggle = document.getElementById('themeToggle');

const progressPanel = document.getElementById('progressPanel');
const groupsContainer = document.getElementById('groupsContainer');
const overallBar = document.getElementById('overallBar');
const overallPercent = document.getElementById('overallPercent');
const closeProgressBtn = document.getElementById('closeProgressBtn');

const floatActions = document.getElementById('floatActions');
const floatDeleteBtn = document.getElementById('floatDeleteBtn');
const floatShareBtn = document.getElementById('floatShareBtn');
const floatCancelBtn = document.getElementById('floatCancelBtn');

let manifestRaw = null;
let manifest = null;
let manifestMap = {};
let activeTab = 'all';
let selectedItems = new Set();
let multiSelectMode = false;

/* session admin key */
function getAdminKeySession(){ return sessionStorage.getItem('admin_key_v1') || null; }
function setAdminKeySession(key){ if(!key) sessionStorage.removeItem('admin_key_v1'); else sessionStorage.setItem('admin_key_v1', key); }
function promptAdminKeyIfNeeded(){ const existing = getAdminKeySession(); if(existing) return existing; const k = prompt('Nhập ADMIN_KEY (sẽ lưu trong session cho phiên này):'); if(!k) return null; const t=k.trim(); setAdminKeySession(t); return t; }

/* theme */
function applyTheme(isDark){ document.body.classList.toggle('dark', !!isDark); sessionStorage.setItem('dark_mode_v1', !!isDark); }
themeToggle.onclick = ()=>{ const isDark = !document.body.classList.contains('dark'); applyTheme(isDark); };
(function(){ const ds = sessionStorage.getItem('dark_mode_v1'); if(ds==='true') applyTheme(true); })();

/* UX helpers */
function logStatus(msg){ statusEl.textContent = msg; console.log(msg); }
function showModal(title, htmlOrNode){ modalTitle.textContent = title; if(typeof htmlOrNode === 'string') modalBody.innerHTML = htmlOrNode; else { modalBody.innerHTML=''; modalBody.appendChild(htmlOrNode);} modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
document.getElementById('modalClose').onclick = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); };
modal.onclick = (e)=>{ if(e.target === modal) document.getElementById('modalClose').click(); };

/* normalize manifest into { sizes: [ {size, barcodes:[{code,images}]} ] }*/
function normalizeManifest(raw){
  if(!raw) return { sizes: [] };
  if(Array.isArray(raw)) return { sizes: raw };
  if(raw.sizes && Array.isArray(raw.sizes)) {
    return { sizes: raw.sizes.map(s=>({ size: String(s.size||s.name||'').trim(), barcodes: Array.isArray(s.barcodes) ? s.barcodes.map(b=>({ code: String(b.code||'').trim(), images: Array.isArray(b.images)?b.images.slice():[] })) : [] })) };
  }
  const sizes=[];
  for(const [k,v] of Object.entries(raw)){
    if(k==='meta'||k==='version') continue;
    if(v && typeof v === 'object' && !Array.isArray(v)){
      const barcodes=[];
      for(const [code, imgs] of Object.entries(v)){ if(Array.isArray(imgs)) barcodes.push({ code: String(code).trim(), images: imgs.slice() }); }
      sizes.push({ size: String(k).trim(), barcodes });
    }
  }
  sizes.sort((a,b)=> { const ai=parseInt(a.size), bi=parseInt(b.size); if(!isNaN(ai)&&!isNaN(bi)) return ai-bi; return a.size.localeCompare(b.size); });
  return { sizes };
}

function buildManifestMap(){
  manifestMap = {};
  if(!manifest || !Array.isArray(manifest.sizes)) return;
  for(const s of manifest.sizes){
    const sizeKey = String(s.size).trim();
    manifestMap[sizeKey] = manifestMap[sizeKey] || {};
    for(const b of s.barcodes){ manifestMap[sizeKey][String(b.code).trim()] = true; }
  }
}
function manifestHas(size, barcode){ return !!(manifestMap[String(size).trim()] && manifestMap[String(size).trim()][String(barcode).trim()]); }

/* fetch manifest */
async function fetchManifest({ forceRefresh=false }={}) {
  try {
    logStatus('Loading manifest...');
    if(forceRefresh){
      const key = promptAdminKeyIfNeeded(); if(!key){ alert('Hủy: cần ADMIN_KEY'); return; }
      const r = await fetch(WORKER_BASE + '/refresh-manifest', { method:'POST', headers:{ 'x-api-key': key }});
      if(!r.ok){ const t=await r.text().catch(()=>r.statusText); throw new Error('Refresh failed: ' + t); }
      manifestRaw = await r.json();
    } else {
      const r = await fetch(WORKER_BASE + '/manifest.json', { cache:'no-store' });
      if(!r.ok){ const t=await r.text().catch(()=>r.statusText); throw new Error('manifest fetch ' + r.status); }
      manifestRaw = await r.json();
    }
    manifest = normalizeManifest(manifestRaw || {});
    buildManifestMap();
    logStatus('Loaded manifest (sizes: ' + manifest.sizes.length + ')');
    buildTabs();
  } catch(err){
    console.error(err); logStatus('Không load được manifest: ' + err.message); contentEl.innerHTML='';
  }
}

/* tab helpers */
function createTabButton(text, key){
  const btn = document.createElement('button');
  btn.className = 'tab' + (activeTab===key ? ' active' : '');
  btn.textContent = text; btn.dataset.key = key;
  btn.onclick = ()=>{
    activeTab = key;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    setActiveButton();
    renderAccording();
    updateHeaderVisibility();
  };
  return btn;
}
function setActiveButton(){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); const btn = document.querySelector(`.tab[data-key="${activeTab}"]`); if(btn) btn.classList.add('active'); }
function buildTabs(){
  tabsEl.innerHTML = '';
  tabsEl.appendChild(createTabButton('Tất cả','all'));
  for(const s of manifest.sizes) tabsEl.appendChild(createTabButton(String(s.size), 'size:'+s.size));
  const spacer = document.createElement('div'); spacer.style.flex='1'; tabsEl.appendChild(spacer);
  tabsEl.appendChild(createTabButton('Thêm','add'));
  setActiveButton();
  renderAccording();
}

/* header hide: only auto-hide on certain tabs */
function updateHeaderVisibility(){ const shouldAutoHide = (activeTab==='all' || activeTab.startsWith('size:')); if(!shouldAutoHide){ headerEl.classList.remove('hidden'); return; } if(window.scrollY === 0) headerEl.classList.remove('hidden'); else headerEl.classList.add('hidden'); }
window.addEventListener('scroll', ()=>{ updateHeaderVisibility(); });

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* create card - checkbox shows if multiSelectMode or withCheckbox param true */
function makeCard(size, bc, withCheckbox=false){
  const card = document.createElement('div'); card.className='card';
  if(withCheckbox || multiSelectMode){
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='checkbox-select';
    const key = `${String(size).trim()}|${String(bc.code).trim()}`;
    cb.checked = selectedItems.has(key);
    cb.onchange = (e)=> { if(e.target.checked) selectedItems.add(key); else selectedItems.delete(key); };
    card.appendChild(cb);
  }

  const thumbName = (Array.isArray(bc.images) && bc.images.find(x=>/thumb/i.test(x))) || (Array.isArray(bc.images)? bc.images[0] : null) || 'thumb.jpeg';
  const encSize = encodeURIComponent(String(size).trim());
  const encCode = encodeURIComponent(String(bc.code).trim());
  const src = `${WORKER_BASE}/${PREFIX}/${encSize}/${encCode}/${encodeURIComponent(thumbName)}`;

  const wrap = document.createElement('div'); wrap.className='thumb-wrap';
  const img = document.createElement('img'); img.src = src; img.alt = bc.code;
  img.onerror = ()=>{ img.style.opacity=0.6; img.style.objectFit='contain' };
  img.onclick = ()=> openDetails(size, bc);
  wrap.appendChild(img);
  card.appendChild(wrap);

  const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='center'; row.style.gap='8px';
  const shareBtn = document.createElement('button'); shareBtn.className='btn share-btn';
  shareBtn.innerHTML = `
    <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' style='vertical-align:middle;margin-right:6px;'>
      <g fill='none' stroke='currentColor' stroke-width='1.4' stroke-linecap='round' stroke-linejoin='round'>
        <rect x='9' y='4' width='11' height='11' rx='1.2' />
        <rect x='4' y='9' width='11' height='11' rx='1.2' />
      </g>
    </svg>
    Share <span class="barcode-strong">${escapeHtml(String(bc.code))}</span>
  `;
  shareBtn.onclick = ()=> shareMultipleImages(size, bc);
  row.appendChild(shareBtn);

  card.appendChild(row);
  return card;
}

function openDetails(size, bc){
  modalTitle.textContent = `${size} — ${bc.code}`;
  modalBody.innerHTML = '';
  const imgs = bc.images || [];
  const div = document.createElement('div'); div.className='two-col';
  for(const fn of imgs){
    const im = document.createElement('img');
    im.src = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(String(size).trim())}/${encodeURIComponent(String(bc.code).trim())}/${encodeURIComponent(fn)}`;
    div.appendChild(im);
  }
  modalBody.appendChild(div);
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}

/* render actions bar:
   - only "Chọn" button visible initially
   - when multiSelectMode=true, show floating panel bottom-left; also we keep local action button for convenience
*/
function renderActionsBar(){
  const bar = document.createElement('div'); bar.className='actions-bar'; bar.style.justifyContent='space-between'; bar.style.marginBottom='10px';
  const left = document.createElement('div');
  const toggleBtn = document.createElement('button'); toggleBtn.className='btn'; toggleBtn.textContent = multiSelectMode ? 'Hủy' : 'Chọn';
  toggleBtn.onclick = ()=>{ multiSelectMode = !multiSelectMode; if(!multiSelectMode) selectedItems.clear(); renderAccording(); updateFloatActionsVisibility(); };
  left.appendChild(toggleBtn);
  bar.appendChild(left);

  const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

  // when multiSelectMode true we also show small inline buttons
  if(multiSelectMode){
    const delInline = document.createElement('button');
    delInline.className = 'btn';
    delInline.style.color = '#fff';
    delInline.style.background = '#ff3b30';
    delInline.style.borderColor = '#ff3b30';
    delInline.textContent = 'Xóa';
    delInline.onclick = ()=> floatDeleteBtn.click();
    right.appendChild(delInline);

    const shareInline = document.createElement('button'); shareInline.className='btn share-btn'; shareInline.textContent = 'Chia sẻ'; shareInline.onclick = ()=> floatShareBtn.click();
    right.appendChild(shareInline);
  }

  bar.appendChild(right);
  return bar;
}

function renderAll(){
  contentEl.innerHTML = '';
  contentEl.appendChild(renderActionsBar());
  for(const s of manifest.sizes){
    const h=document.createElement('div'); h.className='section-title'; h.textContent = s.size; contentEl.appendChild(h);
    const grid=document.createElement('div'); grid.className='grid';
    for(const bc of s.barcodes) grid.appendChild(makeCard(s.size, bc, false));
    contentEl.appendChild(grid);
  }
}
function renderSize(sizeStr){
  contentEl.innerHTML = '';
  contentEl.appendChild(renderActionsBar());
  const s = manifest.sizes.find(x=>String(x.size)===String(sizeStr));
  if(!s){ contentEl.innerHTML='<div class="muted">Không có size này</div>'; return; }
  const grid=document.createElement('div'); grid.className='grid';
  for(const bc of s.barcodes) grid.appendChild(makeCard(s.size, bc, false));
  contentEl.appendChild(grid);
}

/* renderAdd uses .add-container so theme toggles immediately */
function renderAdd(){
  contentEl.innerHTML = '';
  const container = document.createElement('div');
  container.className = 'add-container';

  const controls = document.createElement('div'); controls.style.display='flex'; controls.style.justifyContent='space-between'; controls.style.alignItems='center';
  const left = document.createElement('div'); left.className='controls-left';
  const addRowBtn = document.createElement('button'); addRowBtn.className='btn'; addRowBtn.textContent = '+ Thêm dòng'; left.appendChild(addRowBtn);
  const uploadAllBtn = document.createElement('button'); uploadAllBtn.className='btn'; uploadAllBtn.textContent = 'Upload rows'; left.appendChild(uploadAllBtn);
  const globalAction = document.createElement('select'); const gOpt1 = document.createElement('option'); gOpt1.value='skip'; gOpt1.textContent='Skip if exists (mặc định)'; const gOpt2 = document.createElement('option'); gOpt2.value='overwrite'; gOpt2.textContent='Overwrite if exists'; globalAction.appendChild(gOpt1); globalAction.appendChild(gOpt2); globalAction.style.marginLeft='10px'; left.appendChild(globalAction);
  controls.appendChild(left);
  const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center'; const previewAllBtn = document.createElement('button'); previewAllBtn.className='btn'; previewAllBtn.textContent='Preview all'; right.appendChild(previewAllBtn); controls.appendChild(right);
  container.appendChild(controls);

  // table minimal (kept from previous builds)
  const tableWrap = document.createElement('div'); tableWrap.className='table-wrap';
  const table = document.createElement('table'); table.className='table-add';
  const thead = document.createElement('thead'); thead.innerHTML = `<tr><th>Thumb</th><th>Barcode</th><th>Size</th><th>Details</th><th>Action</th></tr>`; table.appendChild(thead);
  const tbody = document.createElement('tbody'); table.appendChild(tbody); tableWrap.appendChild(table); container.appendChild(tableWrap);

  const folderLabel = document.createElement('div'); folderLabel.className='muted'; folderLabel.textContent='Optional: chọn folder "Shoes" (desktop Chrome/Edge only)';
  const folderInput = document.createElement('input'); folderInput.type='file'; folderInput.webkitdirectory=true; folderInput.directory=true; folderInput.multiple=true; folderInput.style.display='block'; folderInput.style.marginTop='8px';
  container.appendChild(folderLabel); container.appendChild(folderInput);

  function createSizeSelect(selected){ const sel = document.createElement('select'); for(const s of manifest.sizes){ const o = document.createElement('option'); o.value = s.size; o.textContent = s.size; if(String(s.size) === String(selected)) o.selected = true; sel.appendChild(o); } const oNew = document.createElement('option'); oNew.value='__new__'; oNew.textContent='Thêm size mới...'; sel.appendChild(oNew); return sel; }

  function addRow(prefill = {}){
    const tr = document.createElement('tr');
    const tdThumb = document.createElement('td'); const inputThumb = document.createElement('input'); inputThumb.type='file'; inputThumb.accept='image/*'; const thumbPreview = document.createElement('img'); thumbPreview.className='small-thumb'; thumbPreview.alt='thumb'; thumbPreview.style.display='none'; tdThumb.appendChild(inputThumb); tdThumb.appendChild(thumbPreview);
    inputThumb.onchange = (e) => { const f = e.target.files && e.target.files[0]; if(f){ thumbPreview.src = URL.createObjectURL(f); thumbPreview.style.display='block'; tr.__prefilledThumbFile = null; } else { thumbPreview.src = ''; thumbPreview.style.display='none'; } };
    const tdBarcode = document.createElement('td'); const inputBarcode = document.createElement('input'); inputBarcode.type='text'; inputBarcode.placeholder='146888'; if(prefill.barcode) inputBarcode.value = prefill.barcode; tdBarcode.appendChild(inputBarcode);
    const tdSize = document.createElement('td'); const sizeSelect = createSizeSelect(prefill.size|| (manifest.sizes[0] && manifest.sizes[0].size)); const newSizeInput = document.createElement('input'); newSizeInput.type='text'; newSizeInput.placeholder='Nhập size mới...'; newSizeInput.style.display='none'; newSizeInput.style.marginLeft='6px'; newSizeInput.style.minWidth='80px'; tdSize.appendChild(sizeSelect); tdSize.appendChild(newSizeInput);
    sizeSelect.onchange = ()=>{ if(sizeSelect.value === '__new__'){ newSizeInput.style.display='inline-block'; newSizeInput.value = ''; newSizeInput.focus(); } else { newSizeInput.style.display='none'; } };
    if(prefill.size && !manifestMap[String(prefill.size)]){ sizeSelect.value='__new__'; newSizeInput.style.display='inline-block'; newSizeInput.value = prefill.size; }
    const tdDetails = document.createElement('td'); const inputDetails = document.createElement('input'); inputDetails.type='file'; inputDetails.accept='image/*'; inputDetails.multiple = true; const detailsPreviewWrap = document.createElement('div'); detailsPreviewWrap.style.display='flex'; detailsPreviewWrap.style.gap='6px'; detailsPreviewWrap.style.marginTop='6px'; tdDetails.appendChild(inputDetails); tdDetails.appendChild(detailsPreviewWrap);
    inputDetails.onchange = (e) => { detailsPreviewWrap.innerHTML = ''; const files = Array.from(e.target.files || []); for(const f of files){ const img = document.createElement('img'); img.src = URL.createObjectURL(f); img.className='small-thumb'; detailsPreviewWrap.appendChild(img); } tr.__prefilledFiles = null; };
    if(prefill.detailFiles && prefill.detailFiles.length){ for(const f of prefill.detailFiles){ const img = document.createElement('img'); img.src = URL.createObjectURL(f); img.className='small-thumb'; detailsPreviewWrap.appendChild(img); } tr.__prefilledFiles = prefill.detailFiles.slice(); }
    const tdAction = document.createElement('td'); const removeBtn = document.createElement('button'); removeBtn.className='btn'; removeBtn.textContent='Xóa'; removeBtn.style.marginLeft='6px'; removeBtn.onclick = ()=> tr.remove(); const actionWrap = document.createElement('div'); actionWrap.className='row-actions'; actionWrap.appendChild(removeBtn); tdAction.appendChild(actionWrap);
    tr.appendChild(tdThumb); tr.appendChild(tdBarcode); tr.appendChild(tdSize); tr.appendChild(tdDetails); tr.appendChild(tdAction); tbody.appendChild(tr);
    if(prefill.thumbFile){ thumbPreview.src = URL.createObjectURL(prefill.thumbFile); thumbPreview.style.display='block'; tr.__prefilledThumbFile = prefill.thumbFile; }
    return { tr, inputThumb, thumbPreview, inputBarcode, sizeSelect, newSizeInput, inputDetails, detailsPreviewWrap };
  }

  addRowBtn.onclick = ()=> addRow();
  previewAllBtn.onclick = ()=>{ const rows = Array.from(tbody.querySelectorAll('tr')); const gallery = document.createElement('div'); for(const r of rows){ const bc = r.querySelector('input[type=\"text\"]').value || '(no barcode)'; const size = r.querySelector('select').value || ''; const thumbImg = r.querySelector('.small-thumb') && r.querySelector('.small-thumb').src; const wrapper = document.createElement('div'); wrapper.style.marginBottom='8px'; const title = document.createElement('div'); title.textContent = `${size} — ${bc}`; wrapper.appendChild(title); if(thumbImg){ const img = document.createElement('img'); img.src = thumbImg; img.style.maxWidth='160px'; img.style.display='block'; img.style.marginTop='6px'; wrapper.appendChild(img); } gallery.appendChild(wrapper); } showModal('Preview rows', gallery); };

  uploadAllBtn.onclick = async ()=>{
    const key = promptAdminKeyIfNeeded(); if(!key){ alert('Hủy: cần ADMIN_KEY'); return; }
    const rows = Array.from(tbody.querySelectorAll('tr'));
    if(rows.length===0) return alert('Chưa có dòng nào để upload');
    const rowInfos = rows.map(r=>{ const inputThumb = r.querySelector('input[type=\"file\"]'); const barcode = (r.querySelector('input[type=\"text\"]').value || '').trim(); const sizeSel = r.querySelector('select'); const sizeVal = sizeSel.value; const newSizeInput = r.querySelector('input[type=\"text\"]'); const inputDetails = r.querySelector('input[type=\"file\"][multiple]'); return { tr:r, inputThumb, barcode, sizeSel, sizeVal, newSizeInput, inputDetails }; });
    for(const ri of rowInfos){ if(!ri.barcode) return alert('Vui lòng nhập barcode cho tất cả dòng (hoặc xóa dòng trống)'); let detailsFiles = Array.from(ri.inputDetails.files || []); if(detailsFiles.length === 0 && ri.tr.__prefilledFiles && ri.tr.__prefilledFiles.length) detailsFiles = ri.tr.__prefilledFiles.slice(); if(detailsFiles.length === 0) return alert('Mỗi dòng cần ít nhất 1 ảnh detail'); }
    const duplicates = rowInfos.filter(ri => manifestHas((ri.sizeVal==='__new__' ? (ri.newSizeInput && ri.newSizeInput.value) || '' : ri.sizeVal), ri.barcode));
    if(duplicates.length > 0){ const ga = globalAction.value; const msg = `Found ${duplicates.length} existing barcode(s) in manifest.\nAction chosen: ${ga}.\n\nTiếp tục? (Hủy để chỉnh lại)`; if(!confirm(msg)) return; }
    const groups = [];
    for(const ri of rowInfos){
      let detailsFiles = Array.from(ri.inputDetails.files || []);
      if(detailsFiles.length === 0 && ri.tr.__prefilledFiles && ri.tr.__prefilledFiles.length) detailsFiles = ri.tr.__prefilledFiles.slice();
      let effectiveSize = ri.sizeVal;
      if(effectiveSize === '__new__'){ effectiveSize = (ri.newSizeInput && ri.newSizeInput.value || '').trim(); if(!effectiveSize) return alert('Bạn đã chọn Thêm size mới nhưng chưa nhập tên size.'); }
      if(manifestHas(effectiveSize, ri.barcode) && globalAction.value === 'skip') continue;
      const prepared = [];
      let thumbFile = null;
      if(ri.inputThumb && ri.inputThumb.files && ri.inputThumb.files[0]) thumbFile = ri.inputThumb.files[0];
      else if(ri.tr.__prefilledThumbFile) thumbFile = ri.tr.__prefilledThumbFile;
      else if(detailsFiles.length>0) thumbFile = detailsFiles[0];
      if(thumbFile){ const processed = await convertImageFileToJpeg(thumbFile); const thumb = new File([await processed.arrayBuffer()], 'thumb.jpeg', { type: 'image/jpeg' }); prepared.push({ file: thumb, remoteName: 'thumb.jpeg' }); }
      for(const f of detailsFiles){ const p = await convertImageFileToJpeg(f); prepared.push({ file: p, remoteName: p.name }); }
      groups.push({ size: effectiveSize, barcode: ri.barcode, prepared });
    }
    if(groups.length === 0) return alert('Không có hàng để upload sau khi áp dụng skip rules');
    try{
      await uploadPreparedGroups(groups, key);
      let added = false; for(const g of groups){ if(!manifestMap[g.size]){ manifest.sizes.push({ size: String(g.size), barcodes: [] }); added = true; } }
      if(added){ buildManifestMap(); buildTabs(); }
      await fetchManifest();
      alert('Upload tất cả rows hoàn tất');
    } catch(e){ console.error(e); alert('Upload lỗi: ' + e.message); }
  };

  folderInput.onchange = async (e)=>{
    const files = Array.from(folderInput.files || []);
    if(!files.length) return;
    const groupsMap = {};
    for(const f of files){
      const rel = f.webkitRelativePath || f.name;
      const parts = rel.split('/').filter(Boolean);
      let idx = 0; if(parts[0] && parts[0].toLowerCase()==='shoes') idx=1;
      if(parts.length-idx < 3) continue;
      const size = parts[idx].trim();
      const barcode = parts[idx+1].trim();
      const fname = parts.slice(idx+2).join('/');
      if(!groupsMap[size]) groupsMap[size]={};
      if(!groupsMap[size][barcode]) groupsMap[size][barcode]=[];
      groupsMap[size][barcode].push({ file: f, relPath: fname });
    }

    for(const size of Object.keys(groupsMap)){
      for(const barcode of Object.keys(groupsMap[size])){
        const items = groupsMap[size][barcode];
        const detailFiles = items.map(x=>x.file);
        const t = items.find(x=>/thumb\./i.test(x.relPath));
        const thumbFile = t ? t.file : (items[0] && items[0].file);
        const rowObj = addRow({ barcode, size, detailFiles, thumbFile });
        rowObj.tr.__prefilledFiles = detailFiles.slice();
        if(thumbFile) rowObj.tr.__prefilledThumbFile = thumbFile;
        if(!manifestMap[size]){ rowObj.sizeSelect.value='__new__'; rowObj.newSizeInput.style.display='inline-block'; rowObj.newSizeInput.value = size; }
      }
    }
  };

  contentEl.appendChild(container);
}

/* renderAccording */
function renderAccording(){ if(activeTab==='all') renderAll(); else if(activeTab.startsWith('size:')) renderSize(activeTab.split(':')[1]); else if(activeTab==='add') renderAdd(); updateHeaderVisibility(); updateFloatActionsVisibility(); }

/* search */
searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });
function doSearch(){ const q = (searchInput.value||'').trim().toLowerCase(); if(!q){ alert('Nhập barcode để tìm'); return; } const matches = []; for(const s of manifest.sizes) for(const b of s.barcodes) if(String(b.code).toLowerCase().includes(q)) matches.push({ size: s.size, barcode: b }); if(matches.length===0){ alert('Không tìm thấy'); return; } let html = `<div>Found ${matches.length} kết quả</div>`; matches.forEach(m=> html += `<div style="margin-top:8px"><strong>${m.barcode.code}</strong> — ${m.size} <button class="btn" data-size="${m.size}" data-code="${m.barcode.code}">Xem</button></div>`); showModal('Kết quả tìm kiếm', html); setTimeout(()=>{ modalBody.querySelectorAll('button[data-size]').forEach(btn=>btn.onclick = (ev)=> { const s = ev.target.dataset.size; const c = ev.target.dataset.code; document.getElementById('modalClose').click(); activeTab = 'size:'+s; setActiveButton(); renderSize(s); setTimeout(()=> { const cards = Array.from(document.querySelectorAll('.card')); const card = cards.find(cd => cd.textContent.includes(c)); if(card) card.scrollIntoView({behavior:'smooth', block:'center'}); }, 300); }); }, 50); }

/* Refresh & Clear key handlers */
refreshBtn.onclick = async ()=> { try{ const key = promptAdminKeyIfNeeded(); if(!key){ alert('Hủy: cần ADMIN_KEY'); return; } const r = await fetch(WORKER_BASE + '/refresh-manifest', { method:'POST', headers:{ 'x-api-key': key }}); if(!r.ok){ const t = await r.text().catch(()=>r.statusText); throw new Error('Refresh failed: ' + t); } await fetchManifest(); alert('Manifest rebuilt'); } catch(err){ console.error(err); alert('Refresh error: ' + err.message); } };
clearKeyBtn.onclick = ()=> { setAdminKeySession(null); alert('Admin key đã xóa khỏi session'); };

/* ---------- Progress & upload helpers (kept) ---------- */
function showProgressPanel(){ progressPanel.classList.add('open'); progressPanel.setAttribute('aria-hidden','false'); }
function hideProgressPanel(){ progressPanel.classList.remove('open'); progressPanel.setAttribute('aria-hidden','true'); }
closeProgressBtn.onclick = ()=> hideProgressPanel();
function scrollProgressToBottom(){ groupsContainer.scrollTop = groupsContainer.scrollHeight; }
function updateOverallProgress(loaded, total){ const pct = total? Math.round(loaded/total*100) : 0; overallBar.style.width = pct + '%'; overallPercent.textContent = pct + '%'; scrollProgressToBottom(); }
function createGroupProgress(groupId, label){ const row = document.createElement('div'); row.className = 'progress-row'; row.id = 'group-' + groupId; const lbl = document.createElement('div'); lbl.className = 'progress-label'; lbl.innerHTML = `<span>${escapeHtml(label)}</span><span class="group-percent">0%</span>`; const barBg = document.createElement('div'); barBg.className = 'progress-bar-bg'; const barFill = document.createElement('div'); barFill.className = 'progress-bar-fill'; barBg.appendChild(barFill); const fileList = document.createElement('div'); fileList.className = 'file-list'; row.appendChild(lbl); row.appendChild(barBg); row.appendChild(fileList); groupsContainer.appendChild(row); scrollProgressToBottom(); return { row, lbl, barFill, fileList }; }
function addFileStatus(fileListEl, fname){ const div = document.createElement('div'); div.className = 'file-status-row'; div.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${escapeHtml(fname)}</div><div class="file-status">0%</div></div><div class="progress-bar-bg" style="margin-top:6px"><div class="progress-bar-fill" style="width:0%"></div></div>`; fileListEl.appendChild(div); scrollProgressToBottom(); return { container: div, progressFill: div.querySelector('.progress-bar-fill'), statusEl: div.querySelector('.file-status') }; }
function updateFileProgress(fileObj, loaded, total){ const pct = total ? Math.round(loaded/total*100) : 0; fileObj.progressFill.style.width = pct + '%'; fileObj.statusEl.textContent = pct + '%'; scrollProgressToBottom(); }
function updateGroupProgress(groupEl, loaded, total){ const pct = total? Math.round(loaded/total*100) : 0; groupEl.barFill.style.width = pct + '%'; const percentEl = groupEl.row.querySelector('.group-percent'); if(percentEl) percentEl.textContent = pct + '%'; scrollProgressToBottom(); }
function uploadFileWithProgress(url, file, onProgress){ return new Promise((resolve, reject) => { const xhr = new XMLHttpRequest(); xhr.open('PUT', url, true); if (file.type) xhr.setRequestHeader('Content-Type', file.type); xhr.upload.onprogress = (ev) => { if (ev.lengthComputable && typeof onProgress === 'function') onProgress(ev.loaded, ev.total); }; xhr.onload = () => { if (xhr.status >= 200 && xhr.status < 300) resolve({ ok:true, status: xhr.status, response: xhr.responseText }); else reject(new Error('Upload failed: ' + xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText)); }; xhr.onerror = () => reject(new Error('Network error during upload')); xhr.send(file); }); }
async function convertImageFileToJpeg(file, maxWidth=1600, quality=0.80){ if(!file.type || !file.type.startsWith('image/')) return file; try{ const imgBitmap = await createImageBitmap(file); const scale = imgBitmap.width > maxWidth ? maxWidth / imgBitmap.width : 1; const w = Math.round(imgBitmap.width * scale); const h = Math.round(imgBitmap.height * scale); const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(imgBitmap, 0, 0, w, h); const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality)); const newName = (file.name.replace(/\.[^/.]+$/, '') || 'image') + '.jpeg'; return new File([blob], newName, { type: 'image/jpeg' }); } catch(e){ console.warn('convertImageFileToJpeg failed', e); return file; } }
async function uploadPreparedGroups(preparedGroups, adminKey){ let overallTotal = 0; for(const g of preparedGroups) for(const p of g.prepared) overallTotal += p.file.size; let overallLoaded = 0; showProgressPanel(); groupsContainer.innerHTML = ''; updateOverallProgress(0, overallTotal);
  for(const [gi, g] of preparedGroups.entries()){
    const gid = `${g.size}|${g.barcode}|${gi}`;
    if(!manifestMap[g.size]){ manifest.sizes.push({ size: String(g.size), barcodes: [] }); buildManifestMap(); buildTabs(); }
    const groupEl = createGroupProgress(gid, `${g.size} — ${g.barcode}`);
    const groupTotal = g.prepared.reduce((s,p)=>s + p.file.size, 0);
    let groupLoaded = 0;
    const fileObjs = [];
    for(const p of g.prepared) fileObjs.push(addFileStatus(groupEl.fileList, p.remoteName));
    const filenames = g.prepared.map(p=>p.remoteName);
    const presignRes = await fetch(WORKER_BASE + '/presign-upload', { method:'POST', headers:{ 'Content-Type':'application/json', 'x-api-key': adminKey }, body: JSON.stringify({ size: g.size, barcode: g.barcode, files: filenames, expiresIn: 3600 })});
    if(!presignRes.ok){ const t = await presignRes.text().catch(()=>presignRes.statusText); throw new Error('Presign failed: ' + t); }
    const presignJson = await presignRes.json(); const urls = presignJson.urls || {};
    for(let i=0;i<g.prepared.length;i++){
      const p = g.prepared[i]; const fileObj = fileObjs[i]; const url = urls[p.remoteName]; if(!url) throw new Error('Missing presigned URL for ' + p.remoteName);
      try{ await uploadFileWithProgress(url, p.file, (loaded, total)=>{ updateFileProgress(fileObj, loaded, total); const groupEstimate = groupLoaded + loaded; updateGroupProgress(groupEl, Math.min(groupEstimate, groupTotal), groupTotal); updateOverallProgress(overallLoaded + loaded, overallTotal); }); updateFileProgress(fileObj, p.file.size, p.file.size); groupLoaded += p.file.size; overallLoaded += p.file.size; updateGroupProgress(groupEl, groupLoaded, groupTotal); updateOverallProgress(overallLoaded, overallTotal); fileObj.statusEl.textContent = 'OK'; } catch(e){ fileObj.statusEl.textContent = 'ERR'; console.error('Upload file error', e); throw e; }
    }
    const complete = await fetch(WORKER_BASE + '/complete-upload', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ size: g.size, barcode: g.barcode })});
    if(!complete.ok){ const t = await complete.text().catch(()=>complete.statusText); throw new Error('Complete-upload failed: ' + t); }
  }
  updateOverallProgress(overallLoaded, overallTotal);
}

/* ---------- SHARE (sequential per barcode) ---------- */

/* config for share */
const TIMEOUT_MS = 12000;
const RETRIES = 2;
const MAX_FILES_PER_BARCODE = 20;

function fetchWithTimeout(url, opts={}, timeout=TIMEOUT_MS){
  return new Promise((resolve, reject) => {
    const controller = new AbortController();
    const timer = setTimeout(()=> controller.abort(), timeout);
    fetch(url, { ...opts, signal: controller.signal, mode: 'cors' })
      .then(res => {
        clearTimeout(timer);
        if(!res.ok) return reject(new Error('HTTP ' + res.status));
        resolve(res);
      })
      .catch(err => {
        clearTimeout(timer);
        reject(err);
      });
  });
}

async function fetchBlobWithRetries(url){
  let lastErr = null;
  for(let attempt=0; attempt<=RETRIES; attempt++){
    try{
      const r = await fetchWithTimeout(url, {}, TIMEOUT_MS);
      const blob = await r.blob();
      return blob;
    } catch(e){
      lastErr = e;
      console.warn(`fetch attempt ${attempt+1} failed for ${url}`, e);
      await new Promise(r => setTimeout(r, 200 * (attempt+1)));
    }
  }
  throw lastErr;
}

/* share one barcode sequentially */
async function shareSingleBarcode(size, bc) {
  const imgs = (bc.images || []).slice(0, MAX_FILES_PER_BARCODE);
  if(imgs.length === 0) { alert(`Barcode ${bc.code} không có ảnh để chia sẻ.`); return; }
  showModal(`Chuẩn bị chia sẻ ${bc.code}`, `<div id="prepareMsg">Đang tải ${imgs.length} ảnh…</div>`);
  const files = [];
  const prepEl = document.getElementById('prepareMsg');
  for(let i=0;i<imgs.length;i++){
    const fn = imgs[i];
    if(prepEl) prepEl.textContent = `Đang tải ảnh ${i+1}/${imgs.length}...`;
    const url = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(String(size).trim())}/${encodeURIComponent(String(bc.code).trim())}/${encodeURIComponent(fn)}`;
    try {
      const blob = await fetchBlobWithRetries(url);
      const fname = decodeURIComponent(url.split('/').pop());
      files.push(new File([blob], fname, { type: blob.type }));
    } catch(e){
      console.warn('Không tải được file, bỏ qua', url, e);
    }
  }
  try { document.getElementById('modalClose').click(); } catch(e){}
  if(files.length === 0) { alert(`Không thu thập được ảnh cho barcode ${bc.code}. Bỏ qua.`); return; }
  try {
    if(navigator.canShare && navigator.canShare({ files })) {
      await navigator.share({ files, title: `Images ${bc.code}` });
      return;
    } else {
      alert('Trình duyệt không hỗ trợ chia sẻ file trực tiếp trên thiết bị này.');
      return;
    }
  } catch(err) {
    console.warn('navigator.share failed for', bc.code, err);
    alert(`Không thể chia sẻ barcode ${bc.code}: ${err.message || err}`);
    return;
  }
}

/* share selected: sequentially process each selected barcode */
async function shareSelectedDetails(){
  try {
    if(selectedItems.size === 0) return alert('Chưa chọn mục nào. Bấm Chọn để chọn.');
    const groups = [];
    for(const key of selectedItems){
      const [size, code] = key.split('|');
      const s = manifest.sizes.find(x=>String(x.size)===String(size));
      if(!s) continue;
      const bc = s.barcodes.find(b=>String(b.code)===String(code));
      if(!bc) continue;
      groups.push({ size: size, barcodeObj: bc });
    }
    if(groups.length === 0) return alert('Không tìm thấy mục hợp lệ từ selection.');
    if(!confirm(`Bạn chuẩn bị chia sẻ ${groups.length} barcode lần lượt. Tiếp tục?`)) return;
    for(let i=0;i<groups.length;i++){
      const g = groups[i];
      try {
        await shareSingleBarcode(g.size, g.barcodeObj);
      } catch(e){
        console.error('Lỗi share barcode', g, e);
      }
    }
    alert('Hoàn tất quy trình chia sẻ (đã cố gắng với mọi barcode đã chọn).');
  } catch(e){
    console.error('shareSelectedDetails error', e);
    alert('Lỗi khi chia sẻ: ' + (e.message || e));
  }
}

/* card-level share delegates to shareSingleBarcode */
async function shareMultipleImages(size, barcodeObj){
  try{
    await shareSingleBarcode(size, barcodeObj);
  } catch(err){
    console.error('shareMultipleImages error', err);
    alert('Lỗi khi chia sẻ: ' + (err.message || err));
  }
}

/* ---------- Floating actions handlers ---------- */
function updateFloatActionsVisibility(){
  if(multiSelectMode) {
    floatActions.style.display = 'block';
    floatActions.setAttribute('aria-hidden','false');
  } else {
    floatActions.style.display = 'none';
    floatActions.setAttribute('aria-hidden','true');
  }
}

floatCancelBtn.onclick = () => { multiSelectMode = false; selectedItems.clear(); renderAccording(); updateFloatActionsVisibility(); };
floatShareBtn.onclick = () => { shareSelectedDetails(); };
floatDeleteBtn.onclick = async () => {
  if(selectedItems.size === 0) return alert('Chưa chọn mục để xóa');
  const key = promptAdminKeyIfNeeded(); if(!key){ alert('Hủy: cần ADMIN_KEY'); return; }
  if(!confirm('Xác nhận xóa đã chọn (vĩnh viễn)?')) return;
  const items = Array.from(selectedItems).map(s=>{ const [size, barcode] = s.split('|'); return { size, barcode }; });
  try{
    const r = await fetch(WORKER_BASE + '/bulk-delete', { method:'POST', headers:{ 'Content-Type':'application/json','x-api-key': key }, body: JSON.stringify({ items })});
    if(!r.ok){ const t = await r.text().catch(()=>r.statusText); throw new Error('Delete failed: ' + t); }
    const j = await r.json();
    alert('Xóa hoàn tất. Deleted keys: ' + (j.totalDeleted||0));
    selectedItems.clear(); multiSelectMode = false;
    await fetchManifest(); renderAccording(); updateFloatActionsVisibility();
  } catch(err){ console.error(err); alert('Lỗi xóa: ' + err.message); }
};

/* init */
async function init(){ await fetchManifest(); updateHeaderVisibility(); updateFloatActionsVisibility(); }
init();

</script>
</body>
</html>
