<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shoes Admin — Gallery</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#666;--accent:#0b74de}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#111}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#0f1724;color:#fff}
  header h1{font-size:16px;margin:0}
  .container{padding:14px;max-width:1200px;margin:0 auto}
  .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.secondary{background:#fff;color:#0b74de;border:1px solid #ddd}
  .btn.danger{background:#d64545}
  .panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid #e6e9ef}
  #uploadPanel{display:none;margin-bottom:12px}
  #uploader{border:2px dashed #e0e3ea;padding:12px;border-radius:8px;text-align:center}
  input[type="file"]{display:block;margin:8px auto}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:10px}
  .card{background:#fff;border-radius:8px;overflow:hidden;border:1px solid #e6e9ef;display:flex;flex-direction:column}
  img.thumb{width:100%;height:140px;object-fit:cover;background:#f3f4f6}
  .card .meta{padding:8px;display:flex;flex-direction:column;gap:6px}
  .small{font-size:12px;color:var(--muted)}
  .actions{display:flex;gap:6px}
  .search{flex:1;min-width:160px;padding:8px;border-radius:8px;border:1px solid #ddd}
  .badge{background:#eef3ff;color:#0b4bd8;padding:4px 8px;border-radius:20px;font-size:12px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center}
  .modal .box{background:#fff;padding:12px;border-radius:8px;max-width:90%;max-height:90%;overflow:auto}
  .info{font-size:13px;color:#444}
  footer{padding:10px;text-align:center;color:#999;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>Shoes Admin</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <button id="refreshBtn" class="btn secondary">Refresh manifest</button>
    <button id="toggleUploadBtn" class="btn">Thêm (Upload)</button>
  </div>
</header>

<div class="container">
  <div id="authNotice" class="panel" style="margin-bottom:12px">
    <div class="row">
      <div class="info">Bạn chưa nhập ADMIN KEY. Nhấn <strong>Set Key</strong> để nhập (lưu tạm trong session).</div>
      <div style="margin-left:auto">
        <button id="setKeyBtn" class="btn">Set Key</button>
        <button id="clearKeyBtn" class="btn secondary">Clear Key</button>
      </div>
    </div>
  </div>

  <div id="uploadPanel" class="panel">
    <div id="uploader">
      <div style="margin-bottom:8px">
        <label>Size: <input id="sizeInput" placeholder="VD: 42" style="padding:6px;border-radius:6px;border:1px solid #ddd" /></label>
        <label style="margin-left:12px">Barcode / Folder: <input id="barcodeInput" placeholder="VD: BC123" style="padding:6px;border-radius:6px;border:1px solid #ddd" /></label>
        <label style="margin-left:12px"><input type="checkbox" id="overwriteChk" /> Ghi đè</label>
      </div>
      <div style="margin-bottom:8px">
        <input id="fileInput" type="file" multiple accept="image/*" />
      </div>
      <div id="uploadStatus" class="small">Chọn file để upload. Tối đa concurrency 4. Thumbnails sẽ được tạo tự động.</div>
    </div>
  </div>

  <div class="toolbar">
    <input id="search" class="search" placeholder="Tìm filename hoặc barcode..." />
    <div class="badge" id="totalBadge">0 items</div>
  </div>

  <div id="gallery" class="grid"></div>
</div>

<!-- detail modal -->
<div id="detailModal" class="modal" style="display:none">
  <div class="box" id="detailBox">
    <div style="display:flex;gap:8px;align-items:center">
      <div style="flex:1"><strong id="detailTitle"></strong><div class="small" id="detailMeta"></div></div>
      <div style="display:flex;gap:8px">
        <button id="downloadBtn" class="btn">Download</button>
        <button id="copyBtn" class="btn secondary">Copy link</button>
        <button id="delBtn" class="btn danger">Delete</button>
        <button id="closeDetail" class="btn">Close</button>
      </div>
    </div>
    <div style="margin-top:12px;text-align:center">
      <img id="detailImg" src="" style="max-width:100%;max-height:70vh;object-fit:contain;border-radius:6px" />
    </div>
  </div>
</div>

<footer>© Shoes Admin</footer>

<script>
/* CONFIG — set your worker base URL here */
const WORKER_BASE = 'https://
test.lapproak0.workers.dev'; // <-- CHANGE to your worker URL

/* runtime */
let ADMIN_KEY = sessionStorage.getItem('ADMIN_KEY') || '';
const concurrency = 4;
const maxRetries = 3;

/* DOM */
const uploadPanel = document.getElementById('uploadPanel');
const toggleUploadBtn = document.getElementById('toggleUploadBtn');
const refreshBtn = document.getElementById('refreshBtn');
const fileInput = document.getElementById('fileInput');
const sizeInput = document.getElementById('sizeInput');
const barcodeInput = document.getElementById('barcodeInput');
const overwriteChk = document.getElementById('overwriteChk');
const gallery = document.getElementById('gallery');
const totalBadge = document.getElementById('totalBadge');
const searchInput = document.getElementById('search');
const authNotice = document.getElementById('authNotice');
const setKeyBtn = document.getElementById('setKeyBtn');
const clearKeyBtn = document.getElementById('clearKeyBtn');

const detailModal = document.getElementById('detailModal');
const detailImg = document.getElementById('detailImg');
const detailTitle = document.getElementById('detailTitle');
const detailMeta = document.getElementById('detailMeta');
const downloadBtn = document.getElementById('downloadBtn');
const copyBtn = document.getElementById('copyBtn');
const delBtn = document.getElementById('delBtn');
const closeDetail = document.getElementById('closeDetail');

toggleUploadBtn.addEventListener('click', ()=> uploadPanel.style.display = uploadPanel.style.display === 'none' ? 'block' : 'none');
refreshBtn.addEventListener('click', refreshManifest);
fileInput.addEventListener('change', handleFiles);
searchInput.addEventListener('input', () => renderGallery(filteredManifest()));

setKeyBtn.addEventListener('click', inputAdminKey);
clearKeyBtn.addEventListener('click', ()=> { sessionStorage.removeItem('ADMIN_KEY'); ADMIN_KEY=''; alert('Cleared key'); updateAuthNotice(); });

closeDetail.addEventListener('click', ()=> detailModal.style.display='none');
copyBtn.addEventListener('click', ()=> {
  const url = detailImg.src;
  navigator.clipboard.writeText(url).then(()=> alert('Link copied'));
});
downloadBtn.addEventListener('click', ()=> {
  const url = detailImg.src;
  const a = document.createElement('a'); a.href = url; a.download=''; document.body.appendChild(a); a.click(); a.remove();
});
delBtn.addEventListener('click', async ()=> {
  if (!ADMIN_KEY) return alert('Cần ADMIN KEY để xóa');
  if (!confirm('Xóa luôn file?')) return;
  const key = detailImg.getAttribute('data-key');
  const ok = await deleteFile(key);
  if (ok) {
    detailModal.style.display='none';
    await loadManifest();
  } else alert('Delete failed');
});

/* state */
let manifestRaw = {}; // map size->barcode->filenames

updateAuthNotice();
loadManifest();

function updateAuthNotice(){
  const info = ADMIN_KEY ? `ADMIN KEY đang có (lưu tạm trong session).` : `Bạn chưa nhập ADMIN KEY (cần cho upload/xóa/refresh).`;
  authNotice.querySelector('.info').textContent = info;
  sessionStorage.setItem('ADMIN_KEY', ADMIN_KEY || '');
}

async function inputAdminKey(){
  const v = prompt('Nhập ADMIN API KEY (sẽ lưu tạm trong browser session):','');
  if (v === null) return;
  ADMIN_KEY = v.trim();
  sessionStorage.setItem('ADMIN_KEY', ADMIN_KEY);
  updateAuthNotice();
}

/* Manifest: load, render */
async function loadManifest(){
  try {
    const res = await fetch(`${WORKER_BASE}/manifest.json`);
    if (!res.ok) throw new Error('manifest fetch failed');
    manifestRaw = await res.json();
    renderGallery(flattenManifest(manifestRaw));
  } catch (e) {
    console.error('loadManifest err', e);
    // fallback: try rebuild (admin) if no manifest and we have key
    if (ADMIN_KEY) {
      try {
        await refreshManifest();
      } catch(_) {}
    }
  }
}

async function refreshManifest(){
  if (!ADMIN_KEY) { alert('Cần ADMIN KEY để refresh manifest'); return; }
  const res = await fetch(`${WORKER_BASE}/refresh-manifest`, {
    method:'POST',
    headers: { 'x-api-key': ADMIN_KEY }
  });
  if (!res.ok) { alert('Refresh failed'); return; }
  manifestRaw = (await res.json()).manifest || (await res.json());
  // If API returned {ok:true, manifest:...} or direct manifest
  if (manifestRaw && manifestRaw.ok && manifestRaw.manifest) manifestRaw = manifestRaw.manifest;
  renderGallery(flattenManifest(manifestRaw));
}

function flattenManifest(map){
  const arr = [];
  if (!map || typeof map !== 'object') return arr;
  for (const size of Object.keys(map)) {
    const barcodes = map[size] || {};
    for (const barcode of Object.keys(barcodes)) {
      const files = barcodes[barcode] || [];
      for (const fn of files) {
        arr.push({ size, barcode, filename: fn, key: `Shoes/${size}/${barcode}/${fn}`, thumb: `Shoes/${size}/${barcode}/thumbs/${fn}` });
      }
    }
  }
  // newest first? cannot infer date -> keep order
  totalBadge.textContent = `${arr.length} items`;
  return arr;
}

function filteredManifest(){
  const q = (searchInput.value || '').trim().toLowerCase();
  const all = flattenManifest(manifestRaw);
  if (!q) return all;
  return all.filter(i => (i.filename||'').toLowerCase().includes(q) || (i.barcode||'').toLowerCase().includes(q) || (i.size||'').toLowerCase().includes(q));
}

/* render */
function renderGallery(list){
  gallery.innerHTML = '';
  if (!list.length) { gallery.innerHTML = '<div class="small">No items</div>'; return; }
  for (const it of list) {
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb';
    img.src = `${WORKER_BASE}/${it.thumb}`;
    // fallback to original if thumb doesn't exist
    img.onerror = () => { img.onerror=null; img.src = `${WORKER_BASE}/${it.key}`; };
    img.alt = it.filename;
    img.addEventListener('click', ()=> openDetail(it));
    const meta = document.createElement('div'); meta.className='meta';
    const title = document.createElement('div'); title.textContent = it.filename;
    const small = document.createElement('div'); small.className='small'; small.textContent = `${it.barcode} • size ${it.size}`;
    const actions = document.createElement('div'); actions.className='actions';
    const shareBtn = document.createElement('button'); shareBtn.className='btn secondary'; shareBtn.textContent = 'Share';
    shareBtn.onclick = ()=> { navigator.clipboard.writeText(`${WORKER_BASE}/${it.key}`).then(()=> alert('Link copied')) };
    const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='Delete';
    delBtn.onclick = async (e) => {
      e.stopPropagation();
      if (!ADMIN_KEY) return alert('Cần ADMIN KEY để xóa');
      if (!confirm('Xóa luôn file?')) return;
      const ok = await deleteFile(it.key);
      if (ok) await loadManifest();
    };
    actions.appendChild(shareBtn); actions.appendChild(delBtn);
    meta.appendChild(title); meta.appendChild(small); meta.appendChild(actions);
    card.appendChild(img); card.appendChild(meta);
    gallery.appendChild(card);
  }
}

/* detail modal */
function openDetail(it){
  detailImg.src = `${WORKER_BASE}/${it.key}`;
  detailImg.setAttribute('data-key', it.key);
  detailTitle.textContent = it.filename;
  detailMeta.textContent = `Barcode: ${it.barcode} • Size: ${it.size}`;
  detailModal.style.display='flex';
}

/* delete file */
async function deleteFile(key){
  try {
    const res = await fetch(`${WORKER_BASE}/delete`, {
      method:'POST',
      headers: {'Content-Type':'application/json','x-api-key': ADMIN_KEY},
      body: JSON.stringify({ key })
    });
    if (!res.ok) throw new Error('delete failed');
    return true;
  } catch (e) { console.error(e); return false; }
}

/* UPLOAD logic with concurrency and thumbnail creation */
fileInput.addEventListener('dragover', e => e.preventDefault());
fileInput.addEventListener('drop', e => { e.preventDefault(); fileInput.files = e.dataTransfer.files; handleFiles(); });

async function handleFiles(){
  const files = Array.from(fileInput.files || []);
  if (!files.length) return alert('Chưa chọn file');
  const size = (sizeInput.value || '').trim();
  const barcode = (barcodeInput.value || '').trim();
  if (!size || !barcode) return alert('Nhập size và barcode trước khi upload');
  if (!ADMIN_KEY) return alert('Cần ADMIN KEY để upload');

  const tasks = files.map(f => ({ file: f, size, barcode }));
  // concurrency worker loop
  const queue = tasks.slice();
  const workers = new Array(concurrency).fill(0).map(() => workerLoop(queue));
  await Promise.all(workers);
  // done
  alert('Upload hoàn tất (có thể một vài file lỗi, kiểm tra console).');
  fileInput.value = '';
  await loadManifest();
}

async function workerLoop(queue){
  while (queue.length) {
    const t = queue.shift();
    if (!t) break;
    await uploadWithRetries(t);
  }
}

async function uploadWithRetries(task){
  for (let i=0;i<=maxRetries;i++) {
    try {
      await doUpload(task);
      return;
    } catch (err) {
      console.error('Upload attempt failed', err);
      if (i === maxRetries) {
        console.error('Final fail', task.file.name);
      } else {
        await new Promise(r => setTimeout(r, 1000 * Math.pow(2,i)));
      }
    }
  }
}

async function doUpload({file, size, barcode}) {
  // create thumbnail blob (300px width)
  const thumbBlob = await createThumbnailBlob(file, 300);
  // embed thumbnail name to be stored under thumbs/<filename>
  const thumbName = 'thumbs/' + file.name;
  const form = new FormData();
  form.append('size', size);
  form.append('barcode', barcode);
  form.append('overwrite', overwriteChk.checked ? '1' : '0');
  // append original file
  form.append('file', file, file.name);
  // append thumb with name 'thumbs/filename' so worker saves at .../thumbs/filename
  form.append('thumb', thumbBlob, thumbName);

  const resp = await fetch(`${WORKER_BASE}/upload`, {
    method:'POST',
    headers: { 'x-api-key': ADMIN_KEY },
    body: form
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error('upload failed: ' + txt);
  }
  return;
}

// create thumbnail using canvas
function createThumbnailBlob(file, targetWidth=300) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const ratio = img.naturalHeight / img.naturalWidth;
      const w = targetWidth;
      const h = Math.round(w * ratio);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        resolve(blob);
      }, 'image/jpeg', 0.8);
    };
    img.onerror = (e) => reject(e);
    const fr = new FileReader();
    fr.onload = e => img.src = e.target.result;
    fr.readAsDataURL(file);
  });
}

/* utility: update UI when pressing Enter for admin key (quick) */
document.addEventListener('keydown', (e) => {
  if (e.key === 'k' && (e.ctrlKey || e.metaKey)) inputAdminKey();
});
</script>
</body>
</html>

