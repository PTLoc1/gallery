<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gallery — Shoes</title>
<style>
  :root{--accent:#0b6}
  body{font-family:system-ui,Arial;margin:0;background:#f5f7fb;color:#0b1220}
  header{background:#fff;padding:12px 16px;box-shadow:0 2px 6px rgba(10,10,10,0.06);position:sticky;top:0;z-index:20}
  .tabs{display:flex;gap:8px;overflow:auto;padding:8px}
  .tab{padding:8px 12px;border-radius:8px;background:#e6eef7;border:1px solid #d3e0f3;cursor:pointer;white-space:nowrap}
  .tab.active{background:var(--accent);color:white}
  main{padding:16px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:white;border-radius:10px;padding:8px;box-shadow:0 1px 4px rgba(12,15,30,0.06);text-align:center;display:flex;flex-direction:column;gap:8px}
  .card img{width:100%;height:160px;object-fit:cover;border-radius:8px;cursor:pointer}
  .barcode-row{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .btn{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;background:transparent;cursor:pointer}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:50;align-items:center;justify-content:center}
  .modal.open{display:flex}
  .modal-content{background:white;width:90%;height:85%;border-radius:12px;display:flex;flex-direction:column;overflow:auto}
  .modal-header{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
  .modal-body{padding:10px;overflow:auto}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .two-col img{width:100%;height:auto;border-radius:6px;display:block}
  @media(max-width:700px){.two-col{grid-template-columns:1fr}}
  #status{padding:8px 16px;color:#555}
</style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div style="display:flex;flex-direction:column">
        <strong>Gallery giày</strong>
        <small>Tabs theo Size — bấm ảnh để xem chi tiết</small>
      </div>
      <div><button id="refreshBtn" class="btn">Refresh</button></div>
    </div>
    <div class="tabs" id="tabs"></div>
  </header>

  <main>
    <div id="status">Đang tải manifest...</div>
    <div id="content"></div>
  </main>

  <!-- modal -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div><strong id="modalTitle"></strong></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="downloadModal" class="btn">Tải tất cả</button>
          <button id="closeModal" class="btn">Đóng</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="modalGrid" class="two-col"></div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* ===== CONFIG ===== */
const WORKER_BASE = "https://shoes-worker.lapproak0.workers.dev"; // your worker
const PREFIX = "Shoes"; // all objects are under prefix 'shoes/' in R2
/* ================== */

let manifest = null;
const statusEl = document.getElementById('status');
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const modal = document.getElementById('modal');
const modalGrid = document.getElementById('modalGrid');
const modalTitle = document.getElementById('modalTitle');
const closeModal = document.getElementById('closeModal');
const downloadModal = document.getElementById('downloadModal');

function logStatus(msg) { statusEl.textContent = msg; console.log(msg); }

/* Normalize manifest of multiple possible shapes into:
   { sizes: [ { size: "35", barcodes:[{code:"", images:[]}, ...] }, ... ] } */
function normalizeManifest(raw) {
  console.log("RAW manifest:", raw);
  if (!raw) return { sizes: [] };
  if (Array.isArray(raw)) return { sizes: raw };

  // already correct shape
  if (raw.sizes && Array.isArray(raw.sizes)) {
    return { sizes: raw.sizes.map(s => ({
      size: String(s.size || s.name || ""),
      barcodes: Array.isArray(s.barcodes) ? s.barcodes.map(b => ({ code: String(b.code), images: Array.isArray(b.images) ? b.images.slice() : [] })) : []
    }))};
  }

  // object map: { "35": { "123": [..], ... }, ... }
  if (typeof raw === "object") {
    const sizes = [];
    for (const [k, v] of Object.entries(raw)) {
      if (k === "meta" || k === "version") continue;
      if (v && typeof v === "object" && !Array.isArray(v)) {
        // detect map-of-barcodes -> images
        const barcodes = [];
        let any = false;
        for (const [code, imgs] of Object.entries(v)) {
          if (Array.isArray(imgs)) { any = true; barcodes.push({ code: String(code), images: imgs.slice() }); }
        }
        if (any) {
          const sizeName = String(k).replace(/^Size/i, "");
          sizes.push({ size: sizeName, barcodes });
          continue;
        }
        // fallback if v has barcodes property
        if (Array.isArray(v.barcodes)) {
          const sizeName = String(k).replace(/^Size/i, "");
          sizes.push({ size: sizeName, barcodes: v.barcodes.map(b => ({ code: String(b.code), images: Array.isArray(b.images) ? b.images.slice() : [] }))});
          continue;
        }
      }
      // skip others
    }
    return { sizes };
  }

  return { sizes: [] };
}

async function loadManifest(){
  try {
    logStatus('Fetching manifest...');
    const r = await fetch(WORKER_BASE + '/manifest.json', { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status + ' — ' + await r.text().catch(()=>''));
    const raw = await r.json();
    manifest = normalizeManifest(raw);
    logStatus('Manifest loaded — sizes: ' + (manifest.sizes ? manifest.sizes.length : 0));
    renderTabs();
  } catch (err) {
    console.error('Load manifest failed', err);
    statusEl.innerHTML = `<span style="color:#b00">Không load được manifest: ${err.message}</span>`;
    contentEl.innerHTML = '';
  }
}

function renderTabs(){
  tabsEl.innerHTML = '';
  contentEl.innerHTML = '';
  if (!manifest || !Array.isArray(manifest.sizes) || manifest.sizes.length === 0) {
    statusEl.textContent = 'Không có size trong manifest.';
    return;
  }
  manifest.sizes.forEach((s, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (idx===0 ? ' active' : '');
    btn.textContent = s.size;
    btn.onclick = ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderSize(s); };
    tabsEl.appendChild(btn);
  });
  renderSize(manifest.sizes[0]);
}

function renderSize(sizeObj){
  contentEl.innerHTML = '';
  const grid = document.createElement('div'); grid.className = 'grid';
  const barcodes = Array.isArray(sizeObj.barcodes) ? sizeObj.barcodes : [];
  barcodes.forEach(bc => {
    const card = document.createElement('div'); card.className = 'card';
    const thumbName = (Array.isArray(bc.images) && bc.images.find(x=>/thumb/i.test(x))) || (Array.isArray(bc.images) ? bc.images[0] : null) || 'thumb.jpeg';
    const thumbPath = `${WORKER_BASE}/${PREFIX}/${sizeObj.size}/${bc.code}/${thumbName}`;
    const img = document.createElement('img'); img.src = thumbPath; img.alt = bc.code;
    img.onerror = ()=>{ img.style.opacity=0.6; img.style.objectFit='contain' };
    img.onclick = ()=>openModal(sizeObj.size, bc);
    card.appendChild(img);

    const row = document.createElement('div'); row.className='barcode-row';
    const codeEl = document.createElement('div'); codeEl.textContent = `<${bc.code}>`;
    row.appendChild(codeEl);

    const actions = document.createElement('div');
    // Download ZIP
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Tải Zip';
    dl.onclick = ()=>downloadBarcode(sizeObj.size, bc);
    actions.appendChild(dl);

    // Copy links
    const copyLinksBtn = document.createElement('button'); copyLinksBtn.className='btn'; copyLinksBtn.textContent='Copy links';
    copyLinksBtn.onclick = ()=>copyLinks(sizeObj.size, bc);
    actions.appendChild(copyLinksBtn);

    // Copy images
    const copyImgsBtn = document.createElement('button'); copyImgsBtn.className='btn'; copyImgsBtn.textContent='Copy images';
    copyImgsBtn.onclick = ()=>copyImages(sizeObj.size, bc);
    actions.appendChild(copyImgsBtn);

    row.appendChild(actions);
    card.appendChild(row);

    grid.appendChild(card);
  });
  contentEl.appendChild(grid);
}

function openModal(size, barcode) {
  modalTitle.textContent = `Size ${size} — ${barcode.code}`;
  modalGrid.innerHTML = '';
  const imgs = barcode.images.map(fname => `${WORKER_BASE}/${PREFIX}/${size}/${barcode.code}/${fname}`);
  imgs.forEach(src=>{
    const w = document.createElement('div');
    const im = document.createElement('img'); im.src = src;
    w.appendChild(im);
    modalGrid.appendChild(w);
  });
  downloadModal.onclick = ()=>downloadBarcode(size, barcode);
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
document.getElementById('closeModal').onclick = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
modal.onclick = (e)=>{ if(e.target===modal) document.getElementById('closeModal').click(); }

async function downloadBarcode(size, barcode){
  try{
    const zip = new JSZip();
    const folder = zip.folder(`${size}_${barcode.code}`);
    for(const fname of barcode.images){
      const url = `${WORKER_BASE}/${PREFIX}/${size}/${barcode.code}/${fname}`;
      try{
        const res = await fetch(url);
        if(!res.ok){ console.warn('fetch failed', url); continue; }
        const blob = await res.blob();
        folder.file(fname, blob);
      }catch(e){ console.warn('fetch err', e); }
    }
    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, `${size}_${barcode.code}.zip`);
  }catch(e){
    alert('Lỗi tạo zip: '+e.message);
  }
}

async function copyLinks(size, barcode){
  try{
    const links = barcode.images.map(f=>`${WORKER_BASE}/${PREFIX}/${size}/${barcode.code}/${f}`).join('\n');
    await navigator.clipboard.writeText(links);
    alert('Đã copy links vào clipboard');
  }catch(e){ alert('Không copy được links: '+e.message); }
}

async function copyImages(size, barcode){
  try{
    const blobs = [];
    for(const f of barcode.images){
      const url = `${WORKER_BASE}/${PREFIX}/${size}/${barcode.code}/${f}`;
      const r = await fetch(url, { mode:'cors' });
      if(!r.ok) throw new Error('Fetch fail ' + r.status);
      const b = await r.blob();
      blobs.push(b);
    }
    const items = blobs.map(b => new ClipboardItem({ [b.type]: b }));
    await navigator.clipboard.write(items);
    alert('Đã copy ảnh (paste vào app hỗ trợ).');
  }catch(e){
    console.warn('copy images failed', e);
    if(confirm('Không copy được ảnh trực tiếp. Copy links thay thế?')) copyLinks(size, barcode);
  }
}

document.getElementById('refreshBtn').onclick = loadManifest;
document.addEventListener('DOMContentLoaded', loadManifest);
</script>
</body>
</html>
