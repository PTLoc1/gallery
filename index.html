<script>
// Worker base (giữ nguyên)
const WORKER_BASE = "https://shoes-worker.lapproak0.workers.dev";

// --- Utility: normalize manifest to expected shape ---
function normalizeManifest(raw) {
  console.log("RAW manifest:", raw);
  // If already in expected shape
  if (!raw) return { sizes: [] };
  if (Array.isArray(raw)) return { sizes: raw };

  if (raw.sizes && Array.isArray(raw.sizes)) {
    // ensure each entry has 'size' and 'barcodes' array
    const normalized = raw.sizes.map(s => ({
      size: (s.size !== undefined ? String(s.size) : (s.name || s.sizeName || "")),
      barcodes: Array.isArray(s.barcodes) ? s.barcodes.map(b => ({
        code: b.code + "",
        images: Array.isArray(b.images) ? b.images.slice() : []
      })) : []
    }));
    return { sizes: normalized };
  }

  // If manifest is a mapping: { "Size35": { "123": ["thumb.jpg", ...], ... }, ... }
  if (typeof raw === "object") {
    const sizes = [];
    for (const [k, v] of Object.entries(raw)) {
      // skip known top-level keys like metadata
      if (k === "meta" || k === "version") continue;

      // If v is object containing barcodes->images map
      if (v && typeof v === "object" && !Array.isArray(v)) {
        // Case: v has keys that are barcode codes mapping to array of filenames
        const barcodes = [];
        let looksLikeMap = false;
        for (const [code, imgs] of Object.entries(v)) {
          if (Array.isArray(imgs)) {
            looksLikeMap = true;
            barcodes.push({ code: String(code), images: imgs.slice() });
          }
        }
        if (looksLikeMap) {
          // k might be "Size35" or "35"
          const sizeName = String(k).replace(/^Size/i, "");
          sizes.push({ size: sizeName, barcodes });
          continue;
        }

        // Or maybe v itself already has structure { barcodes: [...] }
        if (Array.isArray(v.barcodes)) {
          sizes.push({
            size: String(k).replace(/^Size/i, ""),
            barcodes: v.barcodes.map(b => ({ code: String(b.code), images: Array.isArray(b.images) ? b.images.slice() : [] }))
          });
          continue;
        }
      }

      // If k looks like numeric size and v is array of barcodes
      if (Array.isArray(v)) {
        // assume array of barcodes with shape { code, images }
        sizes.push({ size: String(k).replace(/^Size/i, ""), barcodes: v.map(b => ({ code: String(b.code||b[0]||""), images: Array.isArray(b.images) ? b.images.slice() : [] })) });
        continue;
      }
    }
    return { sizes };
  }

  // fallback
  return { sizes: [] };
}

// --- New safe manifest loader + renderer glue ---
let manifest = null;
async function loadManifest() {
  try {
    const res = await fetch(WORKER_BASE + '/manifest.json', { cache: 'no-store' });
    if (!res.ok) {
      const txt = await res.text().catch(()=>"(no body)");
      throw new Error('HTTP ' + res.status + ' - ' + txt);
    }
    const raw = await res.json();
    manifest = normalizeManifest(raw);
    console.log("NORMALIZED manifest:", manifest);
    renderTabs(); // call your existing render logic but ensure it reads manifest.sizes
  } catch (err) {
    // show user-friendly message and detailed console
    document.getElementById('content').innerHTML = `<p style="color:#b00">Không load được manifest: ${err.message}</p>`;
    console.error("Failed to load/normalize manifest:", err);
  }
}

// Replace existing renderTabs / renderSize to use normalized data
function renderTabs(){
  const tabsEl = document.getElementById('tabs');
  const contentEl = document.getElementById('content');
  tabsEl.innerHTML = '';
  if (!manifest || !Array.isArray(manifest.sizes) || manifest.sizes.length === 0) {
    contentEl.innerHTML = '<p>Không có size trong manifest.</p>';
    return;
  }
  manifest.sizes.forEach((s, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (idx===0 ? ' active' : '');
    btn.textContent = s.size;
    btn.onclick = ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderSize(s); };
    tabsEl.appendChild(btn);
  });
  renderSize(manifest.sizes[0]);
}

function renderSize(sizeObj) {
  const contentEl = document.getElementById('content');
  contentEl.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid';
  const barcodes = Array.isArray(sizeObj.barcodes) ? sizeObj.barcodes : [];
  barcodes.forEach(bc => {
    const card = document.createElement('div'); card.className = 'card';
    const thumbName = (Array.isArray(bc.images) && bc.images.find(x=>/thumb/i.test(x))) || (Array.isArray(bc.images) ? bc.images[0] : null) || 'thumb.jpeg';
    const thumbPath = `${WORKER_BASE}/shoes/${sizeObj.size}/${bc.code}/${thumbName}`;
    const img = document.createElement('img'); img.src = thumbPath; img.alt = bc.code;
    img.onerror = ()=>{ img.style.opacity=0.6; img.style.objectFit='contain' };
    img.onclick = ()=>openModal(sizeObj.size, bc);
    card.appendChild(img);

    const row = document.createElement('div'); row.className='barcode-row';
    const codeEl = document.createElement('div'); codeEl.textContent = `<${bc.code}>`;
    row.appendChild(codeEl);
    const actions = document.createElement('div');
    // copy links button
    const copyLinksBtn = document.createElement('button'); copyLinksBtn.className='btn'; copyLinksBtn.textContent='Copy links';
    copyLinksBtn.onclick = ()=> {
      const links = (bc.images||[]).map(f=>`${WORKER_BASE}/shoes/${sizeObj.size}/${bc.code}/${f}`).join('\\n');
      navigator.clipboard.writeText(links).then(()=>alert('Đã copy links'));
    };
    actions.appendChild(copyLinksBtn);
    row.appendChild(actions);
    card.appendChild(row);

    grid.appendChild(card);
  });
  contentEl.appendChild(grid);
}

// ensure openModal/download functions use same prefix; define or keep yours
</script>
