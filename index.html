<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery — Shoes</title>
  <style>
    :root{
      --accent:#2b82c9; /* blue-ish accent */
      --header-bg:#e6f3ff; /* light navy-blue */
    }
    body{font-family:system-ui,Arial;margin:0;background:#f0f6fb;color:#082033}
    header{background:var(--header-bg);padding:12px 16px;box-shadow:0 2px 6px rgba(10,10,10,0.06);position:sticky;top:0;z-index:30}
    .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap; /* allow wrapping on small screens */}
    .brand{font-weight:700;color:var(--accent)}
    .search-wrap{flex:1 1 420px; /* grow, shrink, base width 420px */margin-left:12px;min-width:160px;max-width:calc(100% - 200px); /* leave space for buttons on the right */}
    .search-input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:14px;box-sizing:border-box;}
    .search-input{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:14px}
    .tabs{display:flex;gap:8px;overflow:auto;padding:8px;margin-top:8px}
    .tab{padding:8px 12px;border-radius:8px;background:#eaf6ff;border:1px solid #d6ecff;cursor:pointer;white-space:nowrap}
    .tab.active{background:var(--accent);color:white}
    main{padding:12px}
    .status{padding:8px 12px;color:#345}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
    .card{background:white;border-radius:8px;padding:8px;box-shadow:0 1px 4px rgba(12,15,30,0.06);text-align:center;display:flex;flex-direction:column;gap:8px;font-size:13px}
    .card img{width:100%;height:110px;object-fit:cover;border-radius:6px;cursor:pointer}
    .barcode-row{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .btn{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;background:transparent;cursor:pointer;font-size:13px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:50;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal-content{background:white;width:90%;height:85%;border-radius:12px;display:flex;flex-direction:column;overflow:auto}
    .modal-header{padding:10px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between}
    .modal-body{padding:10px;overflow:auto}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .two-col img{width:100%;height:auto;border-radius:6px;display:block}
    @media(max-width:700px){.two-col{grid-template-columns:1fr}}
    .search-results{margin-top:12px}
    .search-item{background:#fff;padding:8px;border-radius:8px;margin-bottom:8px;display:flex;align-items:center;gap:10px}
    .search-thumb{width:70px;height:60px;object-fit:cover;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="top-row">
      <div style="display:flex;align-items:center;gap:10px">
        <div class="brand">Shoes Gallery</div>
        <div style="font-size:13px;color:#0b4d74">(Browse & Save)</div>
      </div>

      <div class="search-wrap">
        <input id="searchInput" class="search-input" placeholder="Tìm theo barcode (VD: 146888) — Enter để tìm" />
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </div>

    <div id="tabs" class="tabs" style="margin-top:8px;"></div>
  </header>

  <main>
    <div id="status" class="status">Đang tải manifest...</div>
    <div id="searchResults" class="search-results" aria-live="polite"></div>
    <div id="content"></div>
  </main>

  <!-- modal -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div><strong id="modalTitle"></strong></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="downloadModal" class="btn">Tải tất cả</button>
          <button id="closeModal" class="btn">Đóng</button>
        </div>
      </div>
      <div class="modal-body"><div id="modalGrid" class="two-col"></div></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
/* CONFIG */
const WORKER_BASE = "https://shoes-worker.lapproak0.workers.dev";
const PREFIX = "Shoes";

const statusEl = document.getElementById('status');
const tabsEl = document.getElementById('tabs');
const contentEl = document.getElementById('content');
const searchEl = document.getElementById('searchInput');
const searchResultsEl = document.getElementById('searchResults');
const modal = document.getElementById('modal');
const modalGrid = document.getElementById('modalGrid');
const modalTitle = document.getElementById('modalTitle');
const closeModalBtn = document.getElementById('closeModal');
const downloadModalBtn = document.getElementById('downloadModal');

function logStatus(msg){ statusEl.textContent = msg; console.log(msg); }

function normalizeManifest(raw) {
  if (!raw) return { sizes: [] };
  if (Array.isArray(raw)) return { sizes: raw };
  if (raw.sizes && Array.isArray(raw.sizes)) {
    return { sizes: raw.sizes.map(s => ({ size: String(s.size||s.name||""), barcodes: Array.isArray(s.barcodes) ? s.barcodes.map(b => ({ code: String(b.code), images: Array.isArray(b.images) ? b.images.slice() : [] })) : [] })) };
  }
  if (typeof raw === "object") {
    const sizes = [];
    for (const [k, v] of Object.entries(raw)) {
      if (k === "meta" || k === "version") continue;
      if (v && typeof v === "object" && !Array.isArray(v)) {
        const barcodes = [];
        let any = false;
        for (const [code, imgs] of Object.entries(v)) {
          if (Array.isArray(imgs)) { any = true; barcodes.push({ code: String(code), images: imgs.slice() }); }
        }
        if (any) {
          const sizeName = String(k).replace(/^Size/i, "");
          sizes.push({ size: sizeName, barcodes });
          continue;
        }
        if (Array.isArray(v.barcodes)) {
          const sizeName = String(k).replace(/^Size/i, "");
          sizes.push({ size: sizeName, barcodes: v.barcodes.map(b => ({ code: String(b.code), images: Array.isArray(b.images) ? b.images.slice() : [] }))});
          continue;
        }
      }
    }
    return { sizes };
  }
  return { sizes: [] };
}

/* LOAD & RENDER */
let manifest = null;
async function loadManifest(){
  try {
    logStatus('Fetching manifest...');
    const r = await fetch(WORKER_BASE + '/manifest.json', { cache: 'no-store' });
    if (!r.ok) throw new Error('HTTP ' + r.status + ' — ' + await r.text().catch(()=>''));
    const raw = await r.json();
    manifest = normalizeManifest(raw);
    logStatus('Manifest loaded — sizes: ' + (manifest.sizes ? manifest.sizes.length : 0));
    renderTabs();
    renderSearchResults(''); // clear search
  } catch (err) {
    console.error('Load manifest failed', err);
    statusEl.innerHTML = `<span style="color:#b00">Không load được manifest: ${err.message}</span>`;
    contentEl.innerHTML = '';
  }
}

function renderTabs(){
  tabsEl.innerHTML = '';
  contentEl.innerHTML = '';
  if (!manifest || !Array.isArray(manifest.sizes) || manifest.sizes.length === 0) {
    statusEl.textContent = 'Không có size trong manifest.';
    return;
  }
  manifest.sizes.forEach((s, idx) => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (idx===0 ? ' active' : '');
    btn.textContent = s.size;
    btn.onclick = ()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); renderSize(s); };
    tabsEl.appendChild(btn);
  });
  renderSize(manifest.sizes[0]);
}

function renderSize(sizeObj){
  contentEl.innerHTML = '';
  const grid = document.createElement('div'); grid.className = 'grid';
  const barcodes = Array.isArray(sizeObj.barcodes) ? sizeObj.barcodes : [];
  barcodes.forEach(bc => {
    const card = document.createElement('div'); card.className = 'card';
    const thumbName = (Array.isArray(bc.images) && bc.images.find(x=>/thumb/i.test(x))) || (Array.isArray(bc.images) ? bc.images[0] : null) || 'thumb.jpeg';
    const thumbPath = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(sizeObj.size)}/${encodeURIComponent(bc.code)}/${encodeURIComponent(thumbName)}`;
    const img = document.createElement('img'); img.src = thumbPath; img.alt = bc.code;
    img.onerror = ()=>{ img.style.opacity=0.6; img.style.objectFit='contain' };
    img.onclick = ()=>openModal(sizeObj.size, bc);
    card.appendChild(img);

    const row = document.createElement('div'); row.className='barcode-row';
    const codeEl = document.createElement('div'); codeEl.textContent = `<${bc.code}>`;
    row.appendChild(codeEl);

    const actions = document.createElement('div');
    // Download ZIP
    const dl = document.createElement('button'); dl.className='btn'; dl.textContent='Tải Zip';
    dl.onclick = ()=>downloadBarcode(sizeObj.size, bc);
    actions.appendChild(dl);

    // Save/share (smart)
    const saveBtn = document.createElement('button'); saveBtn.className='btn';
    // show "Save images" on devices that can share files; otherwise "Tải Zip"
    if (navigator.canShare && typeof File !== 'undefined') {
      // lightweight check — will still fallback inside function if not available
      saveBtn.textContent = isIOS() ? 'Lưu vào Photos' : 'Lưu/Share';
      saveBtn.onclick = ()=>shareMultipleImages(sizeObj.size, bc);
    } else {
      saveBtn.textContent = 'Tải Zip';
      saveBtn.onclick = ()=>downloadBarcode(sizeObj.size, bc);
    }
    actions.appendChild(saveBtn);

    // Copy images (attempt)
    const copyImgsBtn = document.createElement('button'); copyImgsBtn.className='btn'; copyImgsBtn.textContent='Copy ảnh';
    copyImgsBtn.onclick = ()=>copyImages(sizeObj.size, bc);
    actions.appendChild(copyImgsBtn);

    row.appendChild(actions);
    card.appendChild(row);

    grid.appendChild(card);
  });
  contentEl.appendChild(grid);
}

/* SEARCH */
function renderSearchResults(query){
  searchResultsEl.innerHTML = '';
  const q = (query||'').trim();
  if (!q) return;
  const lower = q.toLowerCase();
  const matches = [];
  (manifest.sizes||[]).forEach(s => {
    (s.barcodes||[]).forEach(b => {
      if (String(b.code).toLowerCase().includes(lower)) matches.push({ size: s.size, barcode: b });
    });
  });
  if (matches.length === 0) {
    searchResultsEl.innerHTML = `<div style="color:#666">Không tìm thấy barcode "${q}"</div>`;
    return;
  }
  // render matches
  for (const m of matches) {
    const el = document.createElement('div'); el.className='search-item';
    const thumb = m.barcode.images && m.barcode.images[0] ? `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(m.size)}/${encodeURIComponent(m.barcode.code)}/${encodeURIComponent(m.barcode.images[0])}` : '';
    const im = document.createElement('img'); im.src = thumb; im.className='search-thumb'; im.onerror=()=>{im.style.opacity=0.6};
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div><strong>${m.barcode.code}</strong> — Size ${m.size}</div><div style="font-size:12px;color:#666">Có ${ (m.barcode.images || []).length } ảnh</div>`;
    const actions = document.createElement('div');
    const viewBtn = document.createElement('button'); viewBtn.className='btn'; viewBtn.textContent='Xem';
    viewBtn.onclick = ()=>{ renderTabs(); // ensure tabs exist
      // find and activate the size tab
      const tabBtns = Array.from(document.querySelectorAll('.tab'));
      const t = tabBtns.find(b=>b.textContent === String(m.size));
      if (t) { t.click(); }
      // scroll to card
      setTimeout(()=> {
        // try to find card with barcode text
        const cards = Array.from(document.querySelectorAll('.card'));
        const card = cards.find(c => c.textContent.includes(String(m.barcode.code)));
        if (card) card.scrollIntoView({behavior:'smooth', block:'center'});
      }, 200);
    };
    const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Lưu';
    saveBtn.onclick = ()=>shareMultipleImages(m.size, m.barcode);
    actions.appendChild(viewBtn); actions.appendChild(saveBtn);

    el.appendChild(im); el.appendChild(info); el.appendChild(actions);
    searchResultsEl.appendChild(el);
  }
}

/* MODAL (minimal) */
function openModal(size, barcode) {
  modalTitle.textContent = `Size ${size} — ${barcode.code}`;
  modalGrid.innerHTML = '';
  const imgs = barcode.images.map(fname => `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(size)}/${encodeURIComponent(barcode.code)}/${encodeURIComponent(fname)}`);
  imgs.forEach(src => {
    const w = document.createElement('div');
    const im = document.createElement('img'); im.src = src;
    w.appendChild(im);
    modalGrid.appendChild(w);
  });
  downloadModalBtn.onclick = ()=>downloadBarcode(size, barcode);
  modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
}
closeModalBtn.onclick = ()=>{ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
modal.onclick = e => { if (e.target === modal) closeModalBtn.click(); }

/* DOWNLOAD ZIP */
async function downloadBarcode(size, barcode){
  try{
    const zip = new JSZip();
    const folder = zip.folder(`${size}_${barcode.code}`);
    for(const fname of barcode.images){
      const url = `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(size)}/${encodeURIComponent(barcode.code)}/${encodeURIComponent(fname)}`;
      try{ const res = await fetch(url); if(!res.ok){ console.warn('fetch failed', url); continue;} const blob = await res.blob(); folder.file(fname, blob); } catch(e){ console.warn(e); }
    }
    const blob = await zip.generateAsync({type:'blob'});
    saveAs(blob, `${size}_${barcode.code}.zip`);
  }catch(err){ alert('Lỗi tạo zip: ' + err.message); }
}

/* IMAGES / SHARE / CLIPBOARD HELPERS */
function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

async function shareMultipleImages(size, barcode){
  try {
    const urls = barcode.images.map(f => `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(size)}/${encodeURIComponent(barcode.code)}/${encodeURIComponent(f)}`);
    const files = [];
    for (const u of urls) {
      const r = await fetch(u, { mode: 'cors' });
      if (!r.ok) throw new Error('Fetch failed ' + r.status);
      const blob = await r.blob();
      const fname = decodeURIComponent(u.split('/').pop());
      files.push(new File([blob], fname, { type: blob.type }));
    }

    if (navigator.canShare && navigator.canShare({ files })) {
      await navigator.share({ files, title: 'Images ' + barcode.code });
      return;
    } else {
      // fallback: try copy to clipboard or download zip
      if (confirm('Không hỗ trợ share đa file trên trình duyệt/người dùng. Muốn tải ZIP thay thế?')) {
        await downloadBarcode(size, barcode);
      } else {
        alert('Trên iPhone: thử mở trang trong Safari (iOS 16.4+) để dùng tính năng Save Images.');
      }
    }
  } catch (err) {
    console.error('shareMultipleImages:', err);
    alert('Không thể share ảnh: ' + err.message + '\nSẽ fallback sang ZIP.');
    await downloadBarcode(size, barcode);
  }
}

// Try to copy image blobs into clipboard (may or may not be accepted by target app)
async function copyImages(size, barcode){
  try {
    const urls = barcode.images.map(f => `${WORKER_BASE}/${PREFIX}/${encodeURIComponent(size)}/${encodeURIComponent(barcode.code)}/${encodeURIComponent(f)}`);
    const blobs = [];
    for (const u of urls) {
      const r = await fetch(u, { mode: 'cors' });
      if (!r.ok) throw new Error('Fetch failed ' + r.status);
      blobs.push(await r.blob());
    }
    // attempt
    try {
      const items = blobs.map(b => new ClipboardItem({ [b.type]: b }));
      await navigator.clipboard.write(items);
      alert('Đã copy ảnh vào clipboard. Lưu ý: một số ứng dụng (ví dụ Messenger) không chấp nhận dán ảnh từ clipboard — hãy thử Share hoặc tải ZIP nếu không dán được.');
      return;
    } catch (e) {
      console.warn('clipboard.write images failed', e);
      // fallback to share
      if (confirm('Không thể copy ảnh vào clipboard (trình duyệt/ứng dụng hạn chế). Muốn mở Share (Save) thay thế?')) {
        await shareMultipleImages(size, barcode);
      } else {
        await downloadBarcode(size, barcode);
      }
    }
  } catch (err) {
    console.error('copyImages error', err);
    alert('Không thể copy ảnh: ' + err.message);
  }
}

/* INIT */
document.getElementById('refreshBtn').onclick = loadManifest;
searchEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') renderSearchResults(searchEl.value); });
searchEl.addEventListener('input', (e)=>{ if (!searchEl.value) { searchResultsEl.innerHTML=''; } });
document.addEventListener('DOMContentLoaded', loadManifest);
</script>
</body>
</html>

