<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shoes Admin</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;padding:0}
  header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#111;color:#fff}
  .container{padding:12px}
  .toolbar{display:flex;gap:8px;margin-bottom:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
  .card{background:#fff;border:1px solid #ddd;padding:6px;display:flex;flex-direction:column;gap:6px}
  img.thumb{width:100%;height:140px;object-fit:cover;background:#f0f0f0}
  .btn{background:#0b74de;color:#fff;border:none;padding:8px 12px;border-radius:5px;cursor:pointer}
  .btn-danger{background:#c0392b}
  .small{font-size:12px;color:#666}
  #uploader{border:2px dashed #bbb;padding:12px;text-align:center}
  #progress{margin-top:8px}
</style>
</head>
<body>
<header>
  <div><strong>Shoes Admin</strong></div>
  <div>
    <button id="refreshBtn" class="btn">Refresh</button>
    <button id="uploadTabBtn" class="btn">Thêm (Upload)</button>
  </div>
</header>

<div class="container">
  <div id="uploadPanel" style="display:none">
    <div id="uploader">
      <input id="fileInput" type="file" multiple accept="image/*"><br>
      <small class="small">Kéo thả hoặc chọn file (4-7 ảnh per barcode)</small>
      <div style="margin-top:8px">
        <input id="barcodeInput" placeholder="Barcode / Folder name" />
        <label><input type="checkbox" id="overwriteChk" /> Ghi đè nếu trùng tên</label>
      </div>
      <div id="progress"></div>
    </div>
  </div>

  <div style="margin-bottom:12px">
    <input id="search" placeholder="Search filename or barcode" />
  </div>

  <div id="gallery" class="grid"></div>
</div>

<script>
const WORKER_BASE = 'https://test.lapproak0.workers.dev'; // <- set this
const ADMIN_KEY = '1'; // <- set this (keep safe)
const concurrency = 4;
const maxRetries = 3;

document.getElementById('uploadTabBtn').addEventListener('click', ()=> {
  const p = document.getElementById('uploadPanel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
});
document.getElementById('refreshBtn').addEventListener('click', ()=> loadGallery());
document.getElementById('fileInput').addEventListener('change', handleFiles);
document.getElementById('search').addEventListener('input', evt => filterGallery(evt.target.value));

let manifest = [];

async function loadGallery() {
  const res = await fetch(`${WORKER_BASE}/api/list`);
  const data = await res.json();
  manifest = data.items || [];
  renderGallery(manifest);
}
function renderGallery(items) {
  const g = document.getElementById('gallery');
  g.innerHTML = '';
  for (const it of items) {
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.className='thumb';
    img.src = it.thumb ? `${WORKER_BASE}/file/${encodeURIComponent(it.thumb)}` : `${WORKER_BASE}/file/${encodeURIComponent(it.key)}`;
    img.loading = 'lazy';
    const name = document.createElement('div'); name.textContent = it.filename;
    const meta = document.createElement('div'); meta.className='small'; meta.textContent = it.barcode + ' • ' + new Date(it.uploadedAt).toLocaleString();
    const actions = document.createElement('div');
    const shareBtn = document.createElement('button'); shareBtn.className='btn'; shareBtn.textContent='Share';
    shareBtn.onclick = ()=> { navigator.clipboard.writeText(`${WORKER_BASE}/file/${encodeURIComponent(it.key)}`).then(()=> alert('Link copied')); };
    const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> deleteItem(it.key);
    actions.appendChild(shareBtn); actions.appendChild(delBtn);
    card.appendChild(img); card.appendChild(name); card.appendChild(meta); card.appendChild(actions);
    g.appendChild(card);
  }
}

function filterGallery(q) {
  q = q.trim().toLowerCase();
  if (!q) return renderGallery(manifest);
  renderGallery(manifest.filter(item => (item.filename || '').toLowerCase().includes(q) || (item.barcode||'').toLowerCase().includes(q)));
}

// handle file selection / upload
async function handleFiles(e) {
  const files = Array.from(e.target.files);
  if (!files.length) return;
  const barcode = document.getElementById('barcodeInput').value.trim() || 'unknown';
  const overwrite = document.getElementById('overwriteChk').checked;
  // prepare tasks (create thumbnail for each)
  const tasks = files.map(f => ({ file: f, barcode, filename: f.name }));
  // process with concurrency
  const queue = tasks.slice();
  const workers = new Array(concurrency).fill(0).map(() => workerLoop(queue, overwrite));
  await Promise.all(workers);
  // after uploads, refresh
  await loadGallery();
  alert('Upload finished (or some failed — check console).');
}

async function workerLoop(queue, overwrite) {
  while (queue.length) {
    const task = queue.shift();
    if (!task) break;
    await uploadWithRetries(task, overwrite);
  }
}

async function uploadWithRetries(task, overwrite) {
  for (let i=0;i<=maxRetries;i++) {
    try {
      await doUpload(task, overwrite);
      return;
    } catch (err) {
      console.error('upload failed attempt', i, err);
      if (i === maxRetries) {
        console.error('final fail for', task.file.name, err);
        break;
      }
      await new Promise(r => setTimeout(r, 1000 * Math.pow(2, i))); // backoff
    }
  }
}

async function doUpload(task, overwrite) {
  // Create thumbnail (300px width)
  const thumbBlob = await createThumbnailBlob(task.file, 300);
  const form = new FormData();
  form.append('barcode', task.barcode);
  form.append('filename', task.filename);
  form.append('original', task.file, task.filename);
  form.append('thumb', thumbBlob, 'thumb-'+task.filename);
  // POST to worker
  const resp = await fetch(`${WORKER_BASE}/api/upload`, {
    method: 'POST',
    headers: { 'x-admin-key': ADMIN_KEY },
    body: form
  });
  if (!resp.ok) {
    const txt = await resp.text();
    throw new Error('Upload failed: ' + txt);
  }
  return;
}

function createThumbnailBlob(file, targetWidth) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const ratio = img.height / img.width;
      const w = targetWidth;
      const h = Math.round(w * ratio);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        resolve(blob);
      }, 'image/jpeg', 0.8);
    };
    img.onerror = reject;
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);
  });
}

async function deleteItem(key) {
  if (!confirm('Xóa luôn file?')) return;
  const resp = await fetch(`${WORKER_BASE}/api/delete`, {
    method: 'POST',
    headers: {'Content-Type':'application/json', 'x-admin-key': ADMIN_KEY},
    body: JSON.stringify({ key })
  });
  if (!resp.ok) { alert('Delete failed'); return; }
  await loadGallery();
}

loadGallery();
</script>
</body>
</html>
